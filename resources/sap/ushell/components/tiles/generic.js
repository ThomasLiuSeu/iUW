jQuery.sap.require("sap.ushell.components.tiles.indicatorTileUtils.smartBusinessUtil");jQuery.sap.require("sap.ui.model.analytics.odata4analytics");jQuery.sap.require("sap.ui.core.mvc.Controller");sap.ui.core.mvc.Controller.extend("sap.ushell.components.tiles.generic",{onAfterRendering:function(){var t=this;this.firstTimeVisible=false;this.oKpiTileView=this.getView();this.oViewData=this.oKpiTileView.getViewData();this.oResourceBundle=sap.ushell.components.tiles.utils.getResourceBundleModel().getResourceBundle();this.oTileApi=this.oViewData.chip;if(this.oTileApi.visible){this.oTileApi.visible.attachVisible(this.visibleHandler.bind(this));}this.system=this.oTileApi.url.getApplicationSystem();this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loading);this.getChipConfiguration(function(){if(t.oTileApi.preview.isEnabled()){t.doDummyProcess();}else{t.oKpiTileView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(t.queryServiceUriODataReadRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);});t.fetchEvaluation(t.oConfig,function(){t.DEFINITION_DATA=t.oConfig;if(t.KPI_VALUE_REQUIRED){t.fetchKpiValue(function(k,T){this.KPIVALUE=k;t.doProcess(k,T);},t.logError);}else{t.doProcess();}});}});},getChipConfiguration:function(c){var t=this;try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(t.oTileApi.configuration.getParameterValueAsString("tileConfiguration"),function(a){t.oConfig=a;if(t.oTileApi.preview){t.oTileApi.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system));}c.call();});}catch(e){t.logError(e.message);}},fetchEvaluation:function(c,a){var t=this;if(Number(t.oTileApi.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.DEFINITION_DATA=c;t._updateTileModel(this.DEFINITION_DATA);if(t.oTileApi.visible.isVisible()&&!t.firstTimeVisible){t.firstTimeVisible=true;var b=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(t.oConfig.EVALUATION.ID);if(b){t.oConfig.EVALUATION_FILTERS=b.EVALUATION_FILTERS;a.call(b);}else{try{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(t.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);a.call(f);});}catch(e){t.logError("no evaluation data");}}}else{try{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(t.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);a.call(f);});}catch(e){t.logError("no evaluation data");}}}else{try{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(t.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);a.call(f);});}catch(e){t.logError("no evaluation data");}}},fetchKpiValue:function(c,E){var t=this;var k=0;var a=0;var b=0;var d=0;var w=0;var f=0;var g=0;try{var u=this.DEFINITION_DATA.EVALUATION.ODATA_URL;var s=this.DEFINITION_DATA.EVALUATION.ODATA_ENTITYSET;var T=this.setThresholdValues();var m=T.fullyFormedMeasure;var h=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!h){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.DEFINITION_DATA.EVALUATION_FILTERS,this.DEFINITION_DATA.ADDITIONAL_FILTERS);var q=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oTileApi.url.addSystemToServiceUrl(u),s,m,null,v);if(q){this.QUERY_SERVICE_MODEL=q.model;this.queryUriForKpiValue=q.uri;this.queryServiceUriODataReadRef=this.QUERY_SERVICE_MODEL.read(q.uri,null,null,true,function(i){if(i&&i.results&&i.results.length){k=i.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];var j={};if(q.unit[0]){t._updateTileModel({unit:i.results[0][q.unit[0].name]});j.unit=q.unit[0];j.unit.name=q.unit[0].name;}if(t.oConfig.TILE_PROPERTIES.frameType=="TwoByOne"){if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id)){j=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);}j.numericData=i;}else{j.data=i;}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,j);if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){T.criticalHighValue=i.results[0][T.sCriticalHigh];T.criticalLowValue=i.results[0][T.sCriticalLow];T.warningHighValue=i.results[0][T.sWarningHigh];T.warningLowValue=i.results[0][T.sWarningLow];T.targetValue=i.results[0][T.sTarget];T.trendValue=i.results[0][T.sTrend];}else if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="RELATIVE"){T.targetValue=Number(i.results[0][T.sTarget]);T.criticalHighValue=T.targetValue*T.criticalHighValue/100;T.criticalLowValue=T.targetValue*T.criticalLowValue/100;T.warningHighValue=T.targetValue*T.warningHighValue/100;T.warningLowValue=T.targetValue*T.warningLowValue/100;T.trendValue=Number(i.results[0][T.sTrend]);}c.call(t,k,T);}else{t.logError("no data");}},function(i){if(i&&i.response){jQuery.sap.log.error(i.message+" : "+i.request.requestUri);E.call(t,i);}});}else{t.logError("Error Preparing Query Service URI");}}else{if(h.numericData&&h.numericData.results&&h.numericData.results.length){k=h.numericData.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(h.unit){t._updateTileModel({unit:h.numericData.results[0][h.unit.name]});}if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){T.criticalHighValue=h.numericData.results[0][T.sCriticalHigh];T.criticalLowValue=h.numericData.results[0][T.sCriticalLow];T.warningHighValue=h.numericData.results[0][T.sWarningHigh];T.warningLowValue=h.numericData.results[0][T.sWarningLow];T.targetValue=h.numericData.results[0][T.sTarget];T.trendValue=h.numericData.results[0][T.sTrend];}else if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="RELATIVE"){T.targetValue=Number(h.numericData.results[0][T.sTarget]);T.criticalHighValue=T.targetValue*T.criticalHighValue/100;T.criticalLowValue=T.targetValue*T.criticalLowValue/100;T.warningHighValue=T.targetValue*T.warningHighValue/100;T.warningLowValue=T.targetValue*T.warningLowValue/100;T.trendValue=Number(h.numericData.results[0][T.sTrend]);}c.call(t,k,T);}else{t.logError("no Response from QueryServiceUri");}}}catch(e){t.logError(e);}},_setLocalModelToTile:function(){if(this.getTile().getModel()){}else{this.getTile().setModel(new sap.ui.model.json.JSONModel({}));}},getTile:function(){return this.oKpiTileView.oGenericTile;},_updateTileModel:function(n){var m=this.getTile().getModel().getData();jQuery.extend(m,n);this.getTile().getModel().setData(m);},setToolTip:function(a,c,t){var b=this;var C;var T=this.setThresholdValues();if(t=="CONT"||t=="COMP"){if(this.oKpiTileView.getContent()[0].getTileContent().length){C=b.oKpiTileView.getContent()[0].getTileContent()[0].getContent();var m,d,e,v,f,g,h,i,j;if(c&&c[0]){m=c[0].title;v=c[0].value;h=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(c[0].color);}if(c&&c[1]){d=c[1].title;f=c[1].value;i=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(c[1].color);}if(c&&c[2]){e=c[2].title;g=c[2].value;j=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(c[2].color);}var k={measure:this.oConfig.EVALUATION.COLUMN_NAME,m1:m,v1:v,c1:h,m2:d,v2:f,c2:i,m3:e,v3:g,c3:j};sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(C,t,k);}}else{var s="";if(a=="Error")s="sb.error";if(a=="Neutral")s="sb.neutral";if(a=="Critical")s="sb.critical";if(a=="Good")s="sb.good";var k={status:s,actual:c,target:T.targetValue,cH:T.criticalHighValue,wH:T.warningHighValue,wL:T.warningLowValue,cL:T.criticalLowValue};var C=b.oKpiTileView.getContent()[0].getTileContent()[0].getContent();sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(C,t,k)}},getTrendColor:function(t){var a=this;try{var i=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;var b=this.DEFINITION_DATA.EVALUATION_VALUES;var r=sap.suite.ui.commons.InfoTileValueColor.Neutral;if(i==="MI"){if(t.criticalHighValue&&t.warningHighValue){criticalHighValue=Number(t.criticalHighValue);warningHighValue=Number(t.warningHighValue);if(this.CALCULATED_KPI_VALUE<warningHighValue){r=sap.suite.ui.commons.InfoTileValueColor.Good;}else if(this.CALCULATED_KPI_VALUE<=criticalHighValue){r=sap.suite.ui.commons.InfoTileValueColor.Critical;}else{r=sap.suite.ui.commons.InfoTileValueColor.Error;}}}else if(i==="MA"){if(t.criticalLowValue&&t.warningLowValue){criticalLowValue=Number(t.criticalLowValue);warningLowValue=Number(t.warningLowValue);if(this.CALCULATED_KPI_VALUE<criticalLowValue){r=sap.suite.ui.commons.InfoTileValueColor.Error;}else if(this.CALCULATED_KPI_VALUE<=warningLowValue){r=sap.suite.ui.commons.InfoTileValueColor.Critical;}else{r=sap.suite.ui.commons.InfoTileValueColor.Good;}}}else{if(t.warningLowValue&&t.warningHighValue&&t.criticalLowValue&&t.criticalHighValue){criticalHighValue=Number(t.criticalHighValue);warningHighValue=Number(t.warningHighValue);warningLowValue=Number(t.warningLowValue);criticalLowValue=Number(t.criticalLowValue);if(this.CALCULATED_KPI_VALUE<criticalLowValue||this.CALCULATED_KPI_VALUE>criticalHighValue){r=sap.suite.ui.commons.InfoTileValueColor.Error;}else if((this.CALCULATED_KPI_VALUE>=criticalLowValue&&this.CALCULATED_KPI_VALUE<=warningLowValue)||(this.CALCULATED_KPI_VALUE>=warningHighValue&&this.CALCULATED_KPI_VALUE<=criticalHighValue)){r=sap.suite.ui.commons.InfoTileValueColor.Critical;}else{r=sap.suite.ui.commons.InfoTileValueColor.Good;}}}return r;}catch(e){a.logError(e);}},getTrendIndicator:function(t){var a=this;t=Number(t);try{var b=sap.suite.ui.commons.DeviationIndicator.None;if(t>this.CALCULATED_KPI_VALUE){b=sap.suite.ui.commons.DeviationIndicator.Down;}else if(t<this.CALCULATED_KPI_VALUE){b=sap.suite.ui.commons.DeviationIndicator.Up;}return b;}catch(e){a.logError(e);}},setThresholdValues:function(){var t=this;try{var T={};T.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"MA":T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"RA":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;}}else if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="RELATIVE"){T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);T.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","FIXED");T.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","FIXED");T.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","FIXED");T.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","FIXED");}else{T.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","FIXED");T.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","FIXED");T.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","FIXED");T.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","FIXED");T.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","FIXED");T.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","FIXED");}return T;}catch(e){t.logError(e);}},formSelectStatement:function(o){var t=Object.keys(o);var f="";for(var i=0;i<t.length;i++)if((o[t[i]]!==undefined)&&(o.fullyFormedMeasure))f+=","+o[t[i]];return f;},setTextInTile:function(){var t=this;var a=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oTileApi);this._updateTileModel({header:a.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(t.oConfig),subheader:a.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(t.oConfig)});},logError:function(e){this._updateTileModel({value:"",scale:"",unit:""});if(this.getView().getViewData().deferredObj){this.getView().getViewData().deferredObj.reject();}else{this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Failed);}},refreshHandler:function(){if(!this.firstTimeVisible){if(Number(this.oTileApi.configuration.getParameterValueAsString("isSufficient"))){if(this.KPI_VALUE_REQUIRED){this.doProcess(this.KPIVALUE,this.setThresholdValues());}else{this.doProcess();}}else{this.fetchEvaluation(this.oConfig,function(){if(this.KPI_VALUE_REQUIRED){this.doProcess(this.KPIVALUE,this.setThresholdValues());}else{this.doProcess();}});}}},visibleHandler:function(i){if(!i){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef);}if(i){this.refreshHandler(this);}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef);}});
