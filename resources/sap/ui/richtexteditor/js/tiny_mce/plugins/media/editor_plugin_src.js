/**
 * editor_plugin_src.js
 *
 * Copyright 2009, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://tinymce.moxiecode.com/license
 * Contributing: http://tinymce.moxiecode.com/contributing
 */
(function(){var r=tinymce.explode('id,name,width,height,style,align,class,hspace,vspace,bgcolor,type'),e=tinymce.makeMap(r.join(',')),N=tinymce.html.Node,m,s,J=tinymce.util.JSON,a;m=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]];function b(c){return typeof(c)=="string"?c.replace(/[^0-9%]/g,''):c;}function t(o){var u,c,i;if(o&&!o.splice){c=[];for(i=0;true;i++){if(o[i])c[i]=o[i];else break;}return c;}return o;};tinymce.create('tinymce.plugins.MediaPlugin',{init:function(c,u){var d=this,l={},i,y,f,n;function g(h){return h&&h.nodeName==='IMG'&&c.dom.hasClass(h,'mceItemMedia');};d.editor=c;d.url=u;s='';for(i=0;i<m.length;i++){n=m[i][0];f={name:n,clsids:tinymce.explode(m[i][1]||''),mimes:tinymce.explode(m[i][2]||''),codebase:m[i][3]};for(y=0;y<f.clsids.length;y++)l['clsid:'+f.clsids[y]]=f;for(y=0;y<f.mimes.length;y++)l[f.mimes[y]]=f;l['mceItem'+n]=f;l[n.toLowerCase()]=f;s+=(s?'|':'')+n;}tinymce.each(c.getParam("media_types","video=mp4,m4v,ogv,webm;"+"silverlight=xap;"+"flash=swf,flv;"+"shockwave=dcr;"+"quicktime=mov,qt,mpg,mpeg;"+"shockwave=dcr;"+"windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;"+"realmedia=rm,ra,ram;"+"java=jar;"+"audio=mp3,ogg").split(';'),function(f){var i,h,j;f=f.split(/=/);h=tinymce.explode(f[1].toLowerCase());for(i=0;i<h.length;i++){j=l[f[0].toLowerCase()];if(j)l[h[i]]=j;}});s=new RegExp('write('+s+')\\(([^)]+)\\)');d.lookup=l;c.onPreInit.add(function(){c.schema.addValidElements('object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]');c.parser.addNodeFilter('object,embed,video,audio,script,iframe',function(h){var i=h.length;while(i--)d.objectToImg(h[i]);});c.serializer.addNodeFilter('img',function(h,n,j){var i=h.length,k;while(i--){k=h[i];if((k.attr('class')||'').indexOf('mceItemMedia')!==-1)d.imgToObject(k,j);}});});c.onInit.add(function(){if(c.theme&&c.theme.onResolveName){c.theme.onResolveName.add(function(h,p){if(p.name==='img'&&c.dom.hasClass(p.node,'mceItemMedia'))p.name='media';});}if(c&&c.plugins.contextmenu){c.plugins.contextmenu.onContextMenu.add(function(p,h,j){if(j.nodeName==='IMG'&&j.className.indexOf('mceItemMedia')!==-1)h.add({title:'media.edit',icon:'media',cmd:'mceMedia'});});}});c.addCommand('mceMedia',function(){var h,j;j=c.selection.getNode();if(g(j)){h=c.dom.getAttrib(j,'data-mce-json');if(h){h=J.parse(h);tinymce.each(r,function(n){var v=c.dom.getAttrib(j,n);if(v)h[n]=v;});h.type=d.getType(j.className).name.toLowerCase();}}if(!h){h={type:'flash',video:{sources:[]},params:{}};}c.windowManager.open({file:u+'/media.htm',width:430+parseInt(c.getLang('media.delta_width',0)),height:500+parseInt(c.getLang('media.delta_height',0)),inline:1},{plugin_url:u,data:h});});c.addButton('media',{title:'media.desc',cmd:'mceMedia'});c.onNodeChange.add(function(c,h,j){h.setActive('media',g(j));});},convertUrl:function(u,f){var c=this,d=c.editor,g=d.settings,h=g.url_converter,i=g.url_converter_scope||c;if(!u)return u;if(f)return d.documentBaseURI.toAbsolute(u);return h.call(i,u,'src','object');},getInfo:function(){return{longname:'Media',author:'Moxiecode Systems AB',authorurl:'http://tinymce.moxiecode.com',infourl:'http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media',version:tinymce.majorVersion+"."+tinymce.minorVersion};},dataToImg:function(d,f){var c=this,g=c.editor,h=g.documentBaseURI,j,k,l,i;d.params.src=c.convertUrl(d.params.src,f);k=d.video.attrs;if(k)k.src=c.convertUrl(k.src,f);if(k)k.poster=c.convertUrl(k.poster,f);j=t(d.video.sources);if(j){for(i=0;i<j.length;i++)j[i].src=c.convertUrl(j[i].src,f);}l=c.editor.dom.create('img',{id:d.id,style:d.style,align:d.align,hspace:d.hspace,vspace:d.vspace,src:c.editor.theme.url+'/img/trans.gif','class':'mceItemMedia mceItem'+c.getType(d.type).name,'data-mce-json':J.serialize(d,"'")});l.width=d.width=b(d.width||(d.type=='audio'?"300":"320"));l.height=d.height=b(d.height||(d.type=='audio'?"32":"240"));return l;},dataToHtml:function(d,f){return this.editor.serializer.serialize(this.dataToImg(d,f),{forced_root_block:'',force_absolute:f});},htmlToData:function(h){var f,i,d;d={type:'flash',video:{sources:[]},params:{}};f=this.editor.parser.parse(h);i=f.getAll('img')[0];if(i){d=J.parse(i.attr('data-mce-json'));d.type=this.getType(i.attr('class')).name.toLowerCase();tinymce.each(r,function(n){var v=i.attr(n);if(v)d[n]=v;});}return d;},getType:function(v){var i,c,d;c=tinymce.explode(v,' ');for(i=0;i<c.length;i++){d=this.lookup[c[i]];if(d)return d;}},imgToObject:function(c,d){var f=this,g=f.editor,v,o,h,j,k,l,p,q,u,w,x,y,i,z,A,B,C,D,E;function F(G,H){var I,K,L,w,M;M=g.getParam('flash_video_player_url',f.convertUrl(f.url+'/moxieplayer.swf'));if(M){I=g.documentBaseURI;p.params.src=M;if(g.getParam('flash_video_player_absvideourl',true)){G=I.toAbsolute(G||'',true);H=I.toAbsolute(H||'',true);}L='';K=g.getParam('flash_video_player_flashvars',{url:'$url',poster:'$poster'});tinymce.each(K,function(l,k){l=l.replace(/\$url/,G||'');l=l.replace(/\$poster/,H||'');if(l.length>0)L+=(L?'&':'')+k+'='+escape(l);});if(L.length)p.params.flashvars=L;w=g.getParam('flash_video_player_params',{allowfullscreen:true,allowscriptaccess:true});tinymce.each(w,function(l,k){p.params[k]=""+l;});}};p=c.attr('data-mce-json');if(!p)return;p=J.parse(p);y=this.getType(c.attr('class'));D=c.attr('data-mce-style');if(!D){D=c.attr('style');if(D)D=g.dom.serializeStyle(g.dom.parseStyle(D,'img'));}p.width=c.attr('width')||p.width;p.height=c.attr('height')||p.height;if(y.name==='Iframe'){B=new N('iframe',1);tinymce.each(r,function(k){var l=c.attr(k);if(k=='class'&&l)l=l.replace(/mceItem.+ ?/g,'');if(l&&l.length>0)B.attr(k,l);});for(k in p.params)B.attr(k,p.params[k]);B.attr({style:D,src:p.params.src});c.replace(B);return;}if(this.editor.settings.media_use_script){B=new N('script',1).attr('type','text/javascript');l=new N('#text',3);l.value='write'+y.name+'('+J.serialize(tinymce.extend(p.params,{width:c.attr('width'),height:c.attr('height')}))+');';B.append(l);c.replace(B);return;}if(y.name==='Video'&&p.video.sources[0]){v=new N('video',1).attr(tinymce.extend({id:c.attr('id'),width:b(c.attr('width')),height:b(c.attr('height')),style:D},p.video.attrs));if(p.video.attrs)C=p.video.attrs.poster;u=p.video.sources=t(p.video.sources);for(i=0;i<u.length;i++){if(/\.mp4$/.test(u[i].src))A=u[i].src;}if(!u[0].type){v.attr('src',u[0].src);u.splice(0,1);}for(i=0;i<u.length;i++){q=new N('source',1).attr(u[i]);q.shortEnded=true;v.append(q);}if(A){F(A,C);y=f.getType('flash');}else p.params.src='';}if(y.name==='Audio'&&p.video.sources[0]){E=new N('audio',1).attr(tinymce.extend({id:c.attr('id'),width:b(c.attr('width')),height:b(c.attr('height')),style:D},p.video.attrs));if(p.video.attrs)C=p.video.attrs.poster;u=p.video.sources=t(p.video.sources);if(!u[0].type){E.attr('src',u[0].src);u.splice(0,1);}for(i=0;i<u.length;i++){q=new N('source',1).attr(u[i]);q.shortEnded=true;E.append(q);}p.params.src='';}if(y.name==='EmbeddedAudio'){h=new N('embed',1);h.shortEnded=true;h.attr({id:c.attr('id'),width:b(c.attr('width')),height:b(c.attr('height')),style:D,type:c.attr('type')});for(k in p.params)h.attr(k,p.params[k]);tinymce.each(r,function(k){if(p[k]&&k!='type')h.attr(k,p[k]);});p.params.src='';}if(p.params.src){if(/\.flv$/i.test(p.params.src))F(p.params.src,'');if(d&&d.force_absolute)p.params.src=g.documentBaseURI.toAbsolute(p.params.src);o=new N('object',1).attr({id:c.attr('id'),width:b(c.attr('width')),height:b(c.attr('height')),style:D});tinymce.each(r,function(k){var l=p[k];if(k=='class'&&l)l=l.replace(/mceItem.+ ?/g,'');if(l&&k!='type')o.attr(k,l);});for(k in p.params){x=new N('param',1);x.shortEnded=true;l=p.params[k];if(k==='src'&&y.name==='WindowsMedia')k='url';x.attr({name:k,value:l});o.append(x);}if(this.editor.getParam('media_strict',true)){o.attr({data:p.params.src,type:y.mimes[0]});}else{o.attr({classid:"clsid:"+y.clsids[0],codebase:y.codebase});h=new N('embed',1);h.shortEnded=true;h.attr({id:c.attr('id'),width:b(c.attr('width')),height:b(c.attr('height')),style:D,type:y.mimes[0]});for(k in p.params)h.attr(k,p.params[k]);tinymce.each(r,function(k){if(p[k]&&k!='type')h.attr(k,p[k]);});o.append(h);}if(p.object_html){l=new N('#text',3);l.raw=true;l.value=p.object_html;o.append(l);}if(v)v.append(o);}if(v){if(p.video_html){l=new N('#text',3);l.raw=true;l.value=p.video_html;v.append(l);}}if(E){if(p.video_html){l=new N('#text',3);l.raw=true;l.value=p.video_html;E.append(l);}}var n=v||E||o||h;if(n)c.replace(n);else c.remove();},objectToImg:function(n){var c,d,v,f,g,h,j,w,k,l,i,p,q,u,x,y,z,A,B=this.lookup,C,D,E=this.editor.settings.url_converter,F=this.editor.settings.url_converter_scope,G,H,I,K;function L(n){return new tinymce.html.Serializer({inner:true,validate:false}).serialize(n);};function M(o,P){return B[(o.attr(P)||'').toLowerCase()];}function O(o){var P=o.replace(/^.*\.([^.]+)$/,'$1');return B[P.toLowerCase()||''];}if(!n.parent)return;if(n.name==='script'){if(n.firstChild)C=s.exec(n.firstChild.value);if(!C)return;A=C[1];z={video:{},params:J.parse(C[2])};w=z.params.width;k=z.params.height;}z=z||{video:{},params:{}};g=new N('img',1);g.attr({src:this.editor.theme.url+'/img/trans.gif'});h=n.name;if(h==='video'||h=='audio'){v=n;c=n.getAll('object')[0];d=n.getAll('embed')[0];w=v.attr('width');k=v.attr('height');j=v.attr('id');z.video={attrs:{},sources:[]};D=z.video.attrs;for(h in v.attributes.map)D[h]=v.attributes.map[h];x=n.attr('src');if(x)z.video.sources.push({src:E.call(F,x,'src',n.name)});y=v.getAll("source");for(i=0;i<y.length;i++){x=y[i].remove();z.video.sources.push({src:E.call(F,x.attr('src'),'src','source'),type:x.attr('type'),media:x.attr('media')});}if(D.poster)D.poster=E.call(F,D.poster,'poster',n.name);}if(n.name==='object'){c=n;d=n.getAll('embed')[0];}if(n.name==='embed')d=n;if(n.name==='iframe'){f=n;A='Iframe';}if(c){w=w||c.attr('width');k=k||c.attr('height');l=l||c.attr('style');j=j||c.attr('id');G=G||c.attr('hspace');H=H||c.attr('vspace');I=I||c.attr('align');K=K||c.attr('bgcolor');z.name=c.attr('name');u=c.getAll("param");for(i=0;i<u.length;i++){q=u[i];h=q.remove().attr('name');if(!e[h])z.params[h]=q.attr('value');}z.params.src=z.params.src||c.attr('data');}if(d){w=w||d.attr('width');k=k||d.attr('height');l=l||d.attr('style');j=j||d.attr('id');G=G||d.attr('hspace');H=H||d.attr('vspace');I=I||d.attr('align');K=K||d.attr('bgcolor');for(h in d.attributes.map){if(!e[h]&&!z.params[h])z.params[h]=d.attributes.map[h];}}if(f){w=b(f.attr('width'));k=b(f.attr('height'));l=l||f.attr('style');j=f.attr('id');G=f.attr('hspace');H=f.attr('vspace');I=f.attr('align');K=f.attr('bgcolor');tinymce.each(r,function(h){g.attr(h,f.attr(h));});for(h in f.attributes.map){if(!e[h]&&!z.params[h])z.params[h]=f.attributes.map[h];}}if(z.params.movie){z.params.src=z.params.src||z.params.movie;delete z.params.movie;}if(z.params.src)z.params.src=E.call(F,z.params.src,'src','object');if(v){if(n.name==='video')A=B.video.name;else if(n.name==='audio')A=B.audio.name;}if(c&&!A)A=(M(c,'clsid')||M(c,'classid')||M(c,'type')||{}).name;if(d&&!A)A=(M(d,'type')||O(z.params.src)||{}).name;if(d&&A=='EmbeddedAudio'){z.params.type=d.attr('type');}n.replace(g);if(d)d.remove();if(c){p=L(c.remove());if(p)z.object_html=p;}if(v){p=L(v.remove());if(p)z.video_html=p;}z.hspace=G;z.vspace=H;z.align=I;z.bgcolor=K;g.attr({id:j,'class':'mceItemMedia mceItem'+(A||'Flash'),style:l,width:w||(n.name=='audio'?"300":"320"),height:k||(n.name=='audio'?"32":"240"),hspace:G,vspace:H,align:I,bgcolor:K,"data-mce-json":J.serialize(z,"'")});}});tinymce.PluginManager.add('media',tinymce.plugins.MediaPlugin);})();
