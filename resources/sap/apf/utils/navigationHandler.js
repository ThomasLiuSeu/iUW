/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.utils.navigationHandler");jQuery.sap.require("sap.apf.utils.navContainer");jQuery.sap.require("sap.ui.core.routing.HashChanger");sap.apf.utils.NavigationHandler=function(I){var n,a;var m=I.instances.messageHandler;this.getFilterFromSelectionVariant=function(s,d){function e(f,g){var h;if(g){d(undefined,g);}else{h=sap.apf.utils.Filter.createFilterFromSapUi5FilterJSON(m,f.Filter);d(h);}}sap.apf.utils.navContainer.fetchContent(s,'sap.apf.selectionVariant',m,e);};this.getNavigationTargets=function(){if(!n){c();}return jQuery.extend(true,[],n);};this.getNavigationTargetsWithText=function(){var d;var e=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var s=[];function f(h,i,t){a.forEach(function(j){if(h===j.semanticObject&&i===j.action){j.text=t;}});}function g(h){var d=jQuery.Deferred();var i=[];if(h===s.length){d=jQuery.Deferred();a.forEach(function(k){if(k.text!==""){i.push(k);}});a=i;d.resolve(a);return d.promise();}var j=s[h];e.getSemanticObjectLinks(j,undefined,false,I.instances.component,undefined).done(function(k){k.forEach(function(l){var o=l.intent.split("-");var p=o[1].split("?");p=p[0].split("~");f(j,p[0],l.text);});g(h+1).done(function(){d.resolve(a);});}).fail(function(){return g(h+1);});return d.promise();}if(a){d=jQuery.Deferred();d.resolve(a);return d.promise();}if(!n){c();}a=jQuery.extend(true,[],n);a.forEach(function(h){h.text="";});n.forEach(function(h){if($.inArray(h.semanticObject,s)===-1){s.push(h.semanticObject);}});d=jQuery.Deferred();g(0).done(function(){d.resolve(a);}).fail(function(){d.resolve(a);});return d.promise();};this.navigateToApp=function(d){if(!n){c();}var i;var l=n.length;var s,p,e,f;var h=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance();f={sapApfState:I.functions.serializePath()};f.sapApfState.pathContextHandler=I.functions.serializeContext();f.sapApfCumulativeFilter=I.functions.getCumulativeFilterUpToActiveStep().mapToSapUI5FilterExpression();for(i=0;i<l;i++){if(n[i].id===d){s=b(d);sap.apf.utils.navContainer.pushContent(JSON.stringify(s),'sap.apf.selectionVariant',m,function(g,j){if(j){m.putMessage(j);}else{jQuery.sap.log.info("navigation with containerId "+g);}var C=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(C){p={'sap-apf-selection-variant-id':g};e=C.createEmptyAppState(I.instances.component);e.setData(f);e.save();if(h){h.replaceHash("sap-iapp-state="+e.getKey());}C.toExternal({target:{semanticObject:n[i].semanticObject,action:n[i].action},params:p,appStateKey:e.getKey()});}});return;}}};this.checkMode=function(){var d=jQuery.Deferred();var h=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance&&sap.ui.core.routing.HashChanger.getInstance();var i=/(?:sap-iapp-state=)([^&=]+)/;var x=/(?:sap-xapp-state=)([^&=]+)/;var e,f,g,j,k;if(h){g=i.exec(h.getHash());if(g){e=g[1];}}j=x.exec(window.location.hash);if(j){f=j[1];}if(e){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,e).done(function(l){k=l.getData();if(k.sapApfState){I.functions.deserializeContext(k.sapApfState.pathContextHandler);I.functions.deserializePath(k.sapApfState);d.resolve({navigationMode:"backward"});}});}else if(f){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,f).done(function(l){k=l.getData();if(k&&k.sapApfCumulativeFilter){d.resolve({navigationMode:"forward",sapApfCumulativeFilter:k.sapApfCumulativeFilter});}else{d.resolve({navigationMode:"forward"});}});}else{d.resolve({navigationMode:"forward"});}return d.promise();};function b(s){var d=new Date();var f=I.functions.getCumulativeFilterUpToActiveStep();var e=f.mapToSapUI5FilterExpression();return{"SelectionVariantID":s,"Text":"Temporary Selection Variant Producer = APF, "+d.toUTCString(),"Filter":e};}function c(){n=I.functions.getNavigationTargets();}};}());
