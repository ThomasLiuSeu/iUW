/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.persistence");jQuery.sap.require("sap.apf.core.constants");
sap.apf.core.Persistence=function(I){this.createPath=function(n,C,E){var S=I.coreApi.serializePath();if(E){S.pathContextHandler=E.pathContextHandler;}var o=e(S);var r={data:{AnalysisPath:"",AnalysisPathName:n,LogicalSystem:I.coreApi.getLogicalSystem(),ApplicationConfigurationURL:I.coreApi.getApplicationConfigurationURL(),SerializedAnalysisPath:JSON.stringify(S),StructuredAnalysisPath:JSON.stringify(o)},method:"POST"};if(I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){r.data.AnalyticalConfiguration=I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId();}s(r,R.bind(this));function R(h,i,m){if(m){C({oResponse:h,status:"failed"},i,m);}else{I.messageHandler.check(h&&h.data&&h.statusCode===201&&h.statusText==="Created","Persistence create Path - proper response");C({AnalysisPath:h.data.AnalysisPath,status:"successful"},i,m);}}};this.readPaths=function(C){var r={method:"GET"};s(r,R.bind(this));function R(o,E,m){if(!m&&o&&o.data&&o.data.results){for(var i in o.data.results){o.data.results[i].StructuredAnalysisPath=JSON.parse(o.data.results[i].StructuredAnalysisPath);}}else if(!m||o.statusCode!==200||o.statusText!=="OK"){m=I.messageHandler.createMessageObject({code:'5211'});}if(m){C({oResponse:o,status:"failed"},E,m);}else{C({paths:o.data.results,status:"successful"},E,m);}}};this.deletePath=function(A,C){var r={method:"DELETE"};s(r,R.bind(this),A);function R(o,E,m){if((o.statusCode!==204||o.statusText!=="No Content")&&(!m)){m=I.messageHandler.createMessageObject({code:5201});m.setPrevious(I.messageHandler.createMessageObject({code:5200,aParameters:[o.statusCode,o.statusText]}));}if(m){C({oResponse:o,status:"failed"},E,m);}else{C({status:"successful"},E,m);}}};this.modifyPath=function(A,n,C,E){var S=I.coreApi.serializePath();if(E){S.pathContextHandler=E.pathContextHandler;}var o=e(S);var r={data:{AnalysisPathName:n,LogicalSystem:I.coreApi.getLogicalSystem(),ApplicationConfigurationURL:I.coreApi.getApplicationConfigurationURL(),SerializedAnalysisPath:JSON.stringify(S),StructuredAnalysisPath:JSON.stringify(o)},method:"PUT"};s(r,R.bind(this),A);function R(h,i,m){if((h.statusCode!==204||h.statusText!=="No Content")&&(!m)){m=I.messageHandler.createMessageObject({code:5201});m.setPrevious(I.messageHandler.createMessageObject({code:5200,aParameters:[h.statusCode,h.statusText]}));}if(m){C({oResponse:h,status:"failed"},i,m);}else{C({AnalysisPath:A,status:"successful"},i,m);}}};this.openPath=function(A,C,n){var r={method:"GET"};s(r,R.bind(this),A);function R(o,E,m){var M;if(!m&&o&&o.statusCode===200&&o.data&&o.data.SerializedAnalysisPath){o.data.SerializedAnalysisPath=JSON.parse(o.data.SerializedAnalysisPath);m=a(o.data,n);}if(m){M=I.messageHandler.createMessageObject({code:'5210'});M.setPrevious(m);I.messageHandler.putMessage(M);}if(M){C({oResponse:o,status:"failed"},E,M);}else{C({path:o.data,status:"successful"},E,M);}}};function s(r,l,A){var u=d();switch(r.method){case"GET":if(!r.data&&A){r.requestUri=u+"('"+A+"')";}else if(!r.data&&!A){r.requestUri=u+g();}break;case"POST":if(r.data&&!A){r.requestUri=u;}break;case"DELETE":if(!r.data&&A){r.requestUri=u+"('"+A+"')";}break;case"PUT":if(r.data&&A){r.requestUri=u+"('"+A+"')";}break;default:break;}r.headers={"x-csrf-token":I.coreApi.getXsrfToken(d())};var S=function(D,R){l(R,f(),undefined);};var E=function(o){var m;if(o.messageObject&&o.messageObject.getCode&&o.messageObject.getCode()===5021){l(o,f(),o.messageObject);return;}var h=c(o.response.body);if(h!==undefined){m=I.messageHandler.createMessageObject({code:h});}if(o.response.body.match("274")){m=I.messageHandler.createMessageObject({code:'5207'});}if(o.response.statusCode===400){m=I.messageHandler.createMessageObject({code:'5203'});}if(o.response.statusCode===403){m=I.messageHandler.createMessageObject({code:'5206'});}if(o.response.statusCode===405){m=I.messageHandler.createMessageObject({code:'5202'});}if(o.response.statusCode===404){m=I.messageHandler.createMessageObject({code:'5208'});}if(!m&&o.response.statusCode===500){m=I.messageHandler.createMessageObject({code:'5200',aParameters:[o.response.statusCode,o.response.statusText]});}if(!m){m=I.messageHandler.createMessageObject({code:'5201'});}I.messageHandler.putMessage(m);l(o,f(),m);};I.coreApi.odataRequest(r,S,E);}function g(){var h="";if(I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){h="AnalyticalConfiguration%20eq%20'"+I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()+"'%20and%20";}var u="?$select=AnalysisPath,AnalysisPathName,StructuredAnalysisPath,CreationUTCDateTime,LastChangeUTCDateTime&$filter=("+h+"LogicalSystem%20eq%20'"+I.coreApi.getLogicalSystem()+"'%20and%20"+"ApplicationConfigurationURL%20eq%20'"+I.coreApi.getApplicationConfigurationURL()+"')"+"&$orderby=LastChangeUTCDateTime%20desc";return u;}function c(E){var h=E.match("52[0-9]{2}");if(h){return h[0];}else{return undefined;}}function a(r,n){var p;var m;var o=I.coreApi.getContext();function h(){I.messageHandler.putMessage=p;}function i(){p=I.messageHandler.putMessage;I.messageHandler.putMessage=function(m){throw m;};}if(n!==undefined){r.SerializedAnalysisPath.path.indicesOfActiveSteps[0]=n;}I.coreApi.resetPath(true);i();try{I.coreApi.deserializePath(r.SerializedAnalysisPath);}catch(E){I.coreApi.restoreOriginalPath();I.coreApi.setContext(o);m=b(E);}finally{h();}return m;}function b(E){var m;if(E.type&&E.type==="messageObject"){m=E;}else{m=new I.coreApi.MessageObject({code:sap.apf.core.constants.message.code.errorUnknown});m.setSeverity(sap.apf.core.constants.message.severity.error);m.setMessage("Unknown exception caught "+E.message);}return m;}function d(){var p=I.coreApi.getPersistenceConfiguration().path;var S=p.service+"/"+p.entitySet;return S;}function e(S){var h=[];var j=S.path.steps;var k;for(var i in j){h.push({stepId:j[i].stepId,selectedRepresentationId:j[i].binding.selectedRepresentationId});}k={steps:h,indexOfActiveStep:S.path.indicesOfActiveSteps[0]};return k;}function f(){var C=I.coreApi.getPersistenceConfiguration();var E=I.coreApi.getEntityTypeMetadata(C.path.service,C.path.entitySet);return E;}};
