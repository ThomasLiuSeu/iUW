/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.metadata");jQuery.sap.require("sap.apf.utils.utils");jQuery.sap.require("sap.apf.core.utils.fileExists");
sap.apf.core.Metadata=function(I,a){'use strict';this.type="metadata";var t=this;var b=false;var c=I.coreApi;var m;var A;var e;var h=new I.hashtable(I.messageHandler);var H=new I.hashtable(I.messageHandler);var o=new I.hashtable(I.messageHandler);var d=new I.hashtable(I.messageHandler);var f=new I.hashtable(I.messageHandler);var g=new I.hashtable(I.messageHandler);var O=I.ODataModel||sap.ui.model.odata.ODataModel;var D=false;if(I.deactivateFatalError){D=true;}function l(){if(!e){e=[];m.dataServices.schema.forEach(function(i){i.entityType.forEach(function(j){e.push(j.name);});});}return e;}function n(){I.messageHandler.check(m!==undefined,'sap.apf.metadata - oMetadata is undefined');I.messageHandler.check(m.dataServices,'sap.apf.metadata - oMetadata.dataServices is undefined');I.messageHandler.check(m.dataServices.schema!==undefined,'sap.apf.metadata - oMetadata.dataServices.schema is undefined');I.messageHandler.check(A!==undefined,'sap.apf.metadata - oAnnotation is undefined');}function p(i,j){var k=false,M;m.dataServices.schema.forEach(function(S){S.entityType.forEach(function(N){var P=N.extensions;if(P&&N.name.indexOf(i)>-1){P.forEach(function(Q){if(k){return;}if((Q.name==="semantics")&&((j&&Q.value==="aggregate")||(!j&&Q.value==="parameters"))){k=true;M=N;}});}});});if(k){return M;}return{property:[]};}function q(i,j){var k={},M=false,N;if(!i||(!A.propertyAnnotations)){return{};}var P='Results';if(i.indexOf(P,i.length-P.length)!==-1){i=i.substring(0,i.length-P.length);}jQuery.each(A.propertyAnnotations,function(Q,R){if(M){return;}N=Q.split(".").pop().toString();if(N===i||N.indexOf((i+(j?"ResultsType":"Type")))>-1){M=true;k=A.propertyAnnotations[Q];return;}}.bind(t));return k;}function r(i){function j(M){if(!i.dataType){i.dataType={};}i.dataType[M]=i[M];delete i[M];}function k(M,N){if(jQuery.isArray(i[N])===true){(i[N]).forEach(function(P){i[P.name]=P.value;});delete i[N];}else if(N!=="dataType"&&typeof(i[N])==="object"){if(Object.keys(i[N]).length===0){i[M]="true";}jQuery.each(i[N],function(P,Q){i[M]=Q;});delete i[N];}else{i[M]=i[N];}}jQuery.each(i,function(P){switch(P){case'type':j(P);break;case'maxLength':j(P);break;case'precision':j(P);break;default:var M=P.split(".").pop();if(M.search("ISO")===0){k(M,P);}else{k(M.replace(/^./,M[0].toLowerCase()),P);}break;}});return i;}function s(j,k){if(d.hasItem(j)!==true){n();var M=p(j,false);var N=q(j,false);var P={};if(M.key&&M.key.propertyRef){M.key.propertyRef.forEach(function(W){P[W.name]=null;});}var Q={};var R={allParameters:[],keyParameters:[]};var i,S,T;for(i=0;i<M.property.length;i++){S=M.property[i];S.isKey=P.hasOwnProperty(S.name);T=N[S.name];if(T!==undefined){S=jQuery.extend(S,T);}Q[S.name]=S;}var U,V;for(U in Q){V=r(Q[U]);R.allParameters.push(V);if(V.isKey){R.keyParameters.push(V);}}d.setItem(j,R);}if(!k){return d.getItem(j).allParameters;}return d.getItem(j).keyParameters;}function u(i){var P=[];var j=z(i);if(j){i=E(i);}var k=p(i,true);k.property.forEach(function(M){P.push(M.name);});return P;}function v(j){var i;if(o.hasItem(j)===true){return o.getItem(j);}var k=[];var P=[];var M=[];var N=E(j);var Q=p(N,true);for(i=0;i<Q.property.length;i++){P.push(Q.property[i].name);}var R=s(j,false);for(i=0;i<R.length;i++){M.push(R[i].name);}k=P.concat(M);o.setItem(j,k);return o.getItem(j);}function w(i){var j;if(y(i)){j=i;}else{j=g.getItem(i);j=j||g.getItem(i+"Results");}return j;}function x(k){if(H.hasItem(k)===true){return H.getItem(k);}n();var R=[];var M=p(k,true);var N=q(k,true);for(var i=0;i<M.property.length;i++){var P=M.property[i];if(P.extensions&&P.extensions){var Q=true;for(var j=0;j<P.extensions.length;j++){var S=P.extensions[j];if(S.name==="filterable"&&S.value==="false"){Q=false;break;}}if(Q){R.push(P.name);}}}for(var T in N){if(N[T]&&N[T].filterable&&N[T].filterable==="true"){R.push(T);}}H.setItem(k,R);return H.getItem(k);}function y(i){var e=l();return(jQuery.inArray(i,e)>-1);}function z(M){var N;var P;for(var i=0;i<m.dataServices.schema.length;i++){for(var j=0;j<m.dataServices.schema[i].entityType.length;j++){N=m.dataServices.schema[i].entityType[j].name.split(".").pop();if(N===M){P=m.dataServices.schema[i].entityType[j].extensions;if(!P){return false;}for(var k=0;k<P.length;k++){if(P[k].name==="semantics"){return(P[k].value==="parameters");}}}}}}function B(i){for(var j in A){if(j.split(".").pop().toString().indexOf(i)>-1){return A[j];}}return{};}function C(i,P){var j;var k=z(i);if(k){j=E(i);}if(h.hasItem(i+P)===true){return h.getItem(i+P);}else{n();var M=p(i,!k);var N=q(i,!k);var Q;var R=G(M,P);if(R&&R.name){Q=J(N,P);}else{M=p(j,true);R=G(M,P);N=q(j,true);Q=J(N,P);}var S=K(Q,R);h.setItem(i+P,r(S));return h.getItem(i+P);}}function E(k){var M;for(var i=0;i<m.dataServices.schema.length;i++){for(var j=0;j<m.dataServices.schema[i].entityType.length;j++){M=m.dataServices.schema[i].entityType[j];if(M.name===k){if(M.navigationProperty&&M.navigationProperty.length>0){return F(M.navigationProperty[0].relationship,M.navigationProperty[0].toRole);}else{return k;}}}}return k;}function F(M,N){var P;var Q=M.split(".").pop();for(var i=0;i<m.dataServices.schema.length;i++){for(var j=0;j<m.dataServices.schema[i].association.length;j++){P=m.dataServices.schema[i].association[j];if(P.name===Q){for(var k=0;k<P.end.length;k++){if(P.end[k].role===N){return P.end[k].type.split(".").pop();}}}}}}function G(j,P){for(var i=0;i<j.property.length;i++){if(j.property[i].name===P){return j.property[i];}}return{};}function J(i,P){for(var j in i){if(j===P){return i[j];}}return{};}function K(j,S){for(var i in S){j[i]=S[i];}return j;}function L(){var i,j;var k=c.getUriGenerator().getODataPath(a)+"annotation.xml";var M={loadMetadataAsync:false,annotationURI:k,json:true};var T,N;var P;var Q=new O(a,M);T=Q.getServiceMetadata();if(!T){P="5018";if(D){P="11013";}I.messageHandler.putMessage(I.messageHandler.createMessageObject({code:P,aParameters:[a],oCallingObject:t}));b=true;return;}N=Q.getServiceAnnotations();if(!N){I.messageHandler.putMessage(I.messageHandler.createMessageObject({code:"5017",aParameters:[a],oCallingObject:t}));}m=jQuery.extend(true,{},T);A=jQuery.extend(true,{},N);m.dataServices.schema.forEach(function(R){R.entityContainer.forEach(function(S){if(S.entitySet){S.entitySet.forEach(function(i){j=i.entityType.split(/[. ]+/).pop();g.setItem(i.name,j);});}});});}this.getPropertyMetadata=function(i,P){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect EntityType name or type");I.messageHandler.check(P!==undefined&&typeof P==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect sPropertyName name or type");var j=w(i);if(!j){return{};}return C(j,P);};this.patchEntitySetName=function(i){if(g.hasItem(i)){return i;}if(g.hasItem(i+"Results")){return i+"Results";}return undefined;};this.getFilterableProperties=function(i){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getFilterableProperties incorrect EntityType name or type");var j=w(i);if(!j){return[];}j=E(j);return x(j);};this.getAllPropertiesOfExtendedEntityType=function(i){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getAllProperties incorrect EntityType name or type");var j=w(i);if(!j){return[];}return v(j);};this.getAllAggregatePropertiesOfEntitySet=function(i){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getAllProperties incorrect EntityType name or type");var j=w(i);return u(j);};this.getAllAggregateProperties=function(){var i=[];var e=l();e.forEach(function(j){i=i.concat(u(j));});i=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,i);return i;};this.getAllProperties=function(){var i=[];l().forEach(function(j){i=i.concat(v(j));});i=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,i);return i;};this.getParameterEntitySetKeyPropertiesForService=function(){var i=[];var P=[];l().forEach(function(j){s(j,true).forEach(function(k){i.push(k.name);});});i=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,i);return i;};this.getAllKeys=function(){var i=[];var k=[];l().forEach(function(j){var M=p(j,true);if(!M.name){M=p(j,false);}k=[];if(M.key&&M.key.propertyRef){M.key.propertyRef.forEach(function(N){k.push(N.name);});}i=i.concat(k);});i=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,i);return i;};this.getAttributes=function(P){var e=l();var i=false;var j;l().forEach(function(k){if(i){return;}j=C(k,P);if(j.name){i=true;}});return j;};this.getParameterEntitySetKeyProperties=function(i){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getParameterEntitySetKeyProperties incorrect EntityType name or type");var j=w(i);if(!j){return[];}return s(j,true);};this.getEntityTypeMetadata=function(i){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getEntityTypeMetadata incorrect EntityType name or type");var j=w(i);if(f.hasItem(j)===true){return f.getItem(j);}else{n();var k=B(j);var M={};for(var A in k){var N=A.split(".").pop();N=N.replace(/^./,N[0].toLowerCase());for(var P in k[A]){M[N]=k[A][P];}}var Q=E(j);if(Q!==j){var R=B(j);for(var S in R){var T=S.split(".").pop();T=T.replace(/^./,T[0]);for(var U in k[S]){M[T]=k[S][U];}}}f.setItem(j,M);return f.getItem(j);}};this.getUriSuffix=function(k){var M=w(k);var N;if(z(M)){for(var i=0;i<m.dataServices.schema.length;i++){for(var j=0;j<m.dataServices.schema[i].entityType.length;j++){N=m.dataServices.schema[i].entityType[j];if(N.name===M){if(N.navigationProperty&&N.navigationProperty.length>0){return N.navigationProperty[0].name;}else{return"";}}}}}else{return"";}};this.getEntitySets=function(){var i={};var j=[];m.dataServices.schema.forEach(function(k){k.entityContainer.forEach(function(M){if(M.associationSet){M.associationSet.forEach(function(N){i[N.end[1].entitySet]=true;});}if(M.entitySet){M.entitySet.forEach(function(N){if(!i[N.name]){j.push(N.name);}});}});});return j;};L();if(b){this.failed=true;}};
