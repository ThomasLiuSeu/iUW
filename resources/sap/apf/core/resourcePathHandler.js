/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.core.resourcePathHandler");jQuery.sap.require("sap.apf.core.utils.checkForTimeout");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.messageHandler");jQuery.sap.require("sap.apf.core.messageDefinition");jQuery.sap.require("sap.apf.core.odataProxy");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.utils.startParameter");jQuery.sap.require("sap.apf.core.utils.fileExists");sap.apf.core.ResourcePathHandler=function(i){var t=this;var c=i.coreApi;var m=i.messageHandler;var h=new sap.apf.utils.Hashtable(m);var C;var p;var s=null;var a;var A="";var b=false;var I=false;n();this.getApplicationConfigurationURL=function(){return A;};this.loadConfigFromFilePath=function(F){if(b){return;}if(c.getStartParameterFacade().getAnalyticalConfigurationId()){I=true;}var u=F;A=F;jQuery.ajax({url:u,dataType:"json",success:o,error:function(J,S,E){var M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingRessource,rawText:"Error "+E+" when loading the configuration of the resource location: "+u});m.putMessage(M);},async:false});f();if(I){l();}else{e();}b=true;function o(D,S,J){var M=sap.apf.core.utils.checkForTimeout(J);if(M){m.putMessage(m.createMessageObject({code:sap.apf.core.constants.message.code.errorStartUp,rawText:"Timeout when loading application configuration from "+F+"."}));}if(!D||!D.applicationConfiguration){m.putMessage(m.createMessageObject({code:sap.apf.core.constants.message.code.errorStartUp,rawText:"The application configuration from "+F+" has no valid format."}));return;}if(D.applicationConfiguration.textResourceLocations===undefined){m.putMessage(m.createMessageObject({code:sap.apf.core.constants.message.code.errorStartUp,rawText:"The textResourceLocations is missing in the application configuration from "+F+"."}));return;}var r=D.applicationConfiguration;q(r);var T=D.applicationConfiguration.textResourceLocations;p=D.applicationConfiguration.persistence;j(p);if(!p.path.entitySet){p.path.entitySet=sap.apf.core.constants.entitySets.analysisPath;}if(D.applicationConfiguration.smartBusiness){s=D.applicationConfiguration.smartBusiness;k(s);}if(p.analyticalConfiguration){a=p.analyticalConfiguration;}var v;var u;var P;for(P in sap.apf.core.constants.resourceLocation){if(!sap.apf.core.constants.resourceLocation.hasOwnProperty(P)){continue;}if(r[P]!==undefined){u=r[P];}else{if(T[P]!==undefined){u=T[P];}else{continue;}}if(sap.apf.core.utils.fileExists(u)){h.setItem(P,u);}else{if(!I){v=m.createMessageObject({code:sap.apf.core.constants.message.code.wrongRessourcePath,rawText:"The path "+u+" for resource location "+P+"is not valid."});m.putMessage(v);}}}}function q(r){C=jQuery.extend(true,{},r);delete C.type;delete C.analyticalConfigurationLocation;delete C.applicationMessageDefinitionLocation;delete C.textResourceLocations;delete C.persistence;}};function l(){var o=new sap.apf.core.OdataProxy({serviceRoot:p.path.service,entityTypes:{configuration:sap.apf.core.constants.entitySets.configuration,texts:sap.apf.core.constants.entitySets.texts}},{instance:{coreApi:c,messageHandler:m}});o.readEntity("configuration",function(r,q,u){if(u){m.putMessage(m.createMessageObject({code:"5022",aParameters:[c.getStartParameterFacade().getAnalyticalConfigurationId()]}));}else{var v=JSON.parse(r.SerializedAnalyticalConfiguration);c.loadAnalyticalConfiguration(JSON.parse(r.SerializedAnalyticalConfiguration));d(r.Application,o);if(v.applicationTitle){C.appName=v.applicationTitle.key;C.appTitle=v.applicationTitle.key;}}},[{name:"AnalyticalConfiguration",value:c.getStartParameterFacade().getAnalyticalConfigurationId()}],undefined,false);}function d(o,q){var r=new sap.apf.core.utils.Filter(m,'Application','eq',o);var u=new sap.apf.core.utils.Filter(m,'Language','eq',sap.apf.core.constants.developmentLanguage);u.addAnd(r);var v=["TextElement","TextElementDescription"];q.readCollection('texts',function(w,x,y){if(y){m.putMessage(m.createMessageObject({code:"5023",aParameters:[sap.apf.utils.uriParameter.getConfigurationId()]}));}else{c.loadTextElements(w);}},undefined,v,u,false);}function e(){var u=t.getResourceLocation(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation);var M;if(u!==""){jQuery.ajax({url:u,dataType:"json",success:function(D,S,J){if(D){c.loadAnalyticalConfiguration(D);if(D.applicationTitle){C.appName=D.applicationTitle.key;C.appTitle=D.applicationTitle.key;}}else{M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"No data received when loading analytical configuration file"+u});m.putMessage(M);}},error:function(J,S,E){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"Error "+E+" when loading analytical configuration file"+u});m.putMessage(M);},async:false});}else{M=m.createMessageObject({code:sap.apf.core.constants.message.code.missingAnalyticalConfig,rawText:"No analytical configuration defined in the application configuration"});m.putMessage(M);}}function f(){c.loadMessageConfiguration(sap.apf.core.messageDefinition,true);g(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,false);}function g(r,R){var u=t.getResourceLocation(r);if(u!==""){jQuery.ajax({url:u,dataType:"json",success:o,error:function(J,S,E){var M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"Error "+E+" when loading message configuration file"+u});m.putMessage(M);},async:false});}function o(D,S,J){var M;var q=sap.apf.core.utils.checkForTimeout(J);if(!q){if(D.messageConfiguration){c.loadMessageConfiguration(D.messageConfiguration.definitions,R);}}else{M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"Timeout error when loading message configuration file"+u});m.putMessage(M);}}}function j(o){var M;if(!o||!o.path){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"persistence path configuration is missing in the application configuration"});m.putMessage(M);}if(!o.path.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service in persistence path configuration is missing"});m.putMessage(M);}if(!o.logicalSystem){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"logical system configuration is missing in the application configuration"});m.putMessage(M);}if(!o.logicalSystem.service&&o.logicalSystem.service!==null){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service is missing in logical system configuration  in the application configuration"});m.putMessage(M);}if(o.analyticalConfiguration){if(!o.analyticalConfiguration.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service or entity set are missing in analytical configuration in the application configuration"});m.putMessage(M);}}}function k(o){var M;if(o.evaluations&&!o.evaluations.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service in Smart Business service root configuration is missing"});m.putMessage(M);}if(o.evaluations&&(!o.evaluations.type||o.evaluations.type!=="smartBusinessRequest")){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"type in Smart Business configuration is not smartBusinessRequest"});m.putMessage(M);}if(o.evaluations&&!o.evaluations.entityType){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"entityType in Smart Business service root configuration is missing"});m.putMessage(M);}}this.getResourceLocation=function(r){return h.getItem(r);};this.getPersistenceConfiguration=function(){m.check(b,"RessourcePathHandler: configuration must be loaded before access to ressources");return p;};this.getConfigurationProperties=function(){return C;};function n(){var o=c.getUriGenerator().getApfLocation();h.setItem(sap.apf.core.constants.resourceLocation.apfUiTextBundle,o+"resources/i18n/apfUi.properties");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationUiTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation,"");}};}());
