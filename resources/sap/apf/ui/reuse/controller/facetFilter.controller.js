/*!
* SAP APF Analysis Path Framework
* 
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.require('sap.apf.ui.utils.facetFilterListHandler');sap.ui.controller("sap.apf.ui.reuse.controller.facetFilter",{onInit:function(){var s=this;this.oView=this.getView();this.oCoreApi=this.oView.oCoreApi;this.oUiApi=this.oView.oUiApi;this.oPathContextHandler=this.oView.oPathContextHandler;this.aFacetFilterListData=this.oView.aFacetFilterListData;this.aFacetFilterListControls=this.oView.aFacetFilterListControls;this.aFacetFilterListHandlers=this.aFacetFilterListData.map(function(f){return new sap.apf.ui.utils.FacetFilterListHandler(s.oCoreApi,s.oUiApi,s.oPathContextHandler,f);});this.aFacetFilterListDatasets=this.aFacetFilterListData.map(function(){return[];});this.aCachedSelections=this.aFacetFilterListData.map(function(){return[];});this.aSizeLimitForLists=this.aFacetFilterListData.map(function(){return 100;});this._setInitialBinding();this._populateValueHelpData();this._updateSelectedFilters();},_setInitialBinding:function(){var s=this;this.aFacetFilterListControls.forEach(function(f,i){f.bindItems("/",new sap.m.FacetFilterItem({key:'{key}',text:'{text}',selected:'{selected}'}));var m=new sap.ui.model.json.JSONModel(s.aFacetFilterListDatasets[i]);f.setModel(m);});},_populateValueHelpData:function(){var s=this;this.aFacetFilterListHandlers.forEach(function(f,i){f.fetchValueHelpData().then(s._populateValueHelpDataFor(i));});},_updateSelectedFilters:function(){var s=this;this.aFacetFilterListHandlers.forEach(function(f,i){f.fetchSelectedFilterData().then(s._updateSelectedFilterFor(i));});},_populateValueHelpDataFor:function(i){var f=this.aFacetFilterListControls[i];var F=this.aFacetFilterListData[i];var a=this.aFacetFilterListDatasets[i];var o=f.getModel();var n=this.aSizeLimitForLists[i];return function(d){d.forEach(function(D){var s=false;var b=-1;a.forEach(function(c,i){if(c.key===D.key){b=i;return;}});if(b!==-1){s=a[b].selected;a.splice(b,1);}a.push({key:D.key,text:D.text,selected:s});});if(n<d.length){n=d.length;o.setSizeLimit(n);}o.updateBindings();};},_updateSelectedFilterFor:function(i){var f=this.aFacetFilterListControls[i];var F=this.aFacetFilterListData[i];var a=this.aFacetFilterListDatasets[i];var o=f.getModel();var c=this.aCachedSelections[i];var n=this.aSizeLimitForLists[i];return function(d,e){if(e){var b=f.getParent();b.removeList(i);return;}a.forEach(function(D){D.selected=false;});c.splice(0,c.length);d.forEach(function(D){var m=a.filter(function(g){return g.key===D.key;});m.forEach(function(g){g.selected=true;});if(!m.length){a.push({key:D.key,text:D.text,selected:true});}c.push(D.key);});if(n<d.length){n=d.length;o.setSizeLimit(n);}o.updateBindings();};},onListClose:function(e){var c=e.getSource();var n=this.aFacetFilterListControls.indexOf(c);var p=this.aFacetFilterListData[n].property;var i=e.getParameter('allSelected');var s=[];if(i){var I=c.getBinding("items");var a=I.getModel().getData();s=a.map(function(D){return D.key;});}else{var S=e.getParameter('selectedItems');s=S.map(function(g){return g.getKey();});}var C=this.aCachedSelections[n];if(s.length===C.length){var b=JSON.stringify(s.sort());var d=JSON.stringify(C.sort());var f=(b===d);if(f){return;}}this.aCachedSelections[n]=s;var F=this.oCoreApi.createFilter();var o=F.getTopAnd().addOr();s.forEach(function(v){o.addExpression({name:p,operator:"EQ",value:v});});this.oPathContextHandler.update(p,F);this.oUiApi.selectionChanged(true);},onResetPress:function(){var f=this.aFacetFilterListData.map(function(F){return F.property;});this.oPathContextHandler.restoreInitialContext(f);this.onContextChanged();this.oUiApi.selectionChanged(true);},onContextChanged:function(){this._updateSelectedFilters();},getFormattedFilters:function(p){var a=this.aFacetFilterListData.map(function(F){return F.property;});var n=a.indexOf(p);if(n===-1){return null;}var f=this.aFacetFilterListControls[n];var r=f.getSelectedItems().map(function(i){return{name:f.getTitle(),operator:"EQ",value:i.getText(),formatted:true};});return r;}});
