/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.require("sap.apf.ui.utils.constants");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");sap.ui.controller("sap.apf.modeler.ui.controller.representation",{onInit:function(){this.getView().addStyleClass("sapUiSizeCompact");this.oViewData=this.getView().getViewData();this.oConfigurationHandler=this.oViewData.oConfigurationHandler;this.oConfigurationEditor=this.oViewData.oConfigurationEditor;this.oTextPool=this.oConfigurationHandler.getTextPool();this.getText=this.oViewData.getText;this.getEntityTypeMetadata=this.oViewData.getEntityTypeMetadata;this.getRepresentationTypes=this.oViewData.getRepresentationTypes;this.mParam=this.oViewData.oParams;var s=this;if(!this.oConfigurationEditor){this.oConfigurationHandler.loadConfiguration(this.mParam.arguments.configId,function(c){s.oConfigurationEditor=c;});}this._addConfigStyleClass();this._setDisplayText();this.setDetailData();this._oPreviewButton=new sap.m.Button({text:this.getText("preview"),press:this._handlePreviewButtonPress.bind(this)});this._insertPreviewButtonInFooter();},_addConfigStyleClass:function(){this.byId("idDirectionLabel").addStyleClass("repFormRightLabel");this.byId("idRadioBtnGroup").addStyleClass("radioBtnGrp");this.byId("idChartIcon").addStyleClass("chartIcon");this.byId("idBasicData").addStyleClass("formTextTitle");this.byId("idSorting").addStyleClass("formTextTitle");this.byId("idThumbnailTexts").addStyleClass("formTextTitle");this.byId("idCornerTextLayout").addStyleClass("cornerTextHLayout");this.byId("idScrollContent").addStyleClass("scrollContentLayout");this.byId("idCornerTextLayout").addStyleClass("detailPageDataLayout");this.byId("idBasicDataLayout").addStyleClass("detailPageDataLayout");this.byId("idChartDataLayout").addStyleClass("detailPageDataLayout");},_setDisplayText:function(){this.byId("idChartTypeLabel").setText(this.getText("chartType")+":");this.byId("idBasicData").setText(this.getText("basicData"));this.byId("idSorting").setText(this.getText("sorting"));this.byId("idSortingFieldLabel").setText(this.getText("sortingField")+":");this.byId("idDirectionLabel").setText(this.getText("direction")+":");this.byId("idAscending").setText(this.getText("ascending"));this.byId("idDescending").setText(this.getText("descending"));this.byId("idThumbnailTexts").setText(this.getText("cornerTextLabel"));this.byId("idLeftUpper").setPlaceholder(this.getText("leftTop"));this.byId("idRightUpper").setPlaceholder(this.getText("rightTop"));this.byId("idLeftLower").setPlaceholder(this.getText("leftBottom"));this.byId("idRightLower").setPlaceholder(this.getText("rightBottom"));},handleChangeForChartType:function(e){var n=e.getParameter("selectedItem").getKey();this._updateAndSetDatasetsByChartType(n);this.sCurrentChartType=n;this.oRepresentation.setRepresentationType(n);var a,r;if(n!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){a=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;}var s=this._getChartPictureDataset().sSelectedChartPicture;this.oRepresentation.setAlternateRepresentationType(a);var R=this.getText(this.oRepresentation.getRepresentationType());var S=this.oConfigurationEditor.getCategoriesForStep(this.oParentStep.getId());if(S.length===1){this.oViewData.updateSelectedNode({name:R,icon:s});}else{this.oViewData.updateTree();}var t=this.getText("representation")+": "+R;this.oViewData.updateTitleAndBreadCrumb(t);this.oConfigurationEditor.setIsUnsaved();},handleChangeForCornerText:function(e){var c=e.getSource();var C=c.getValue();var t=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_CORNER_TEXT;var s=this.oTextPool.setText(C,t);var a=c.getBindingPath('value').replace("/","");var S=["set",a,"CornerTextKey"].join("");this.oRepresentation[S](s);this.oConfigurationEditor.setIsUnsaved();this.mDataset.oCornerTextsDataset[a]=this._getCornerTextsDataset()[a];this.mModel.oCornerTextsModel.updateBindings();},_addAutoCompleteFeatureOnInputs:function(){var s=this;var t=new sap.apf.modeler.ui.utils.TextPoolHelper(this.oTextPool);var d={oTranslationFormat:sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_CORNER_TEXT,type:"text"};var c=["idLeftUpper","idRightUpper","idLeftLower","idRightLower"];c.forEach(function(i){var I=s.getView().byId(i);t.setAutoCompleteOn(I,d);});},_bindBasicRepresentationData:function(){var s=this;var b=this.byId("idBasicDataLayout");var p=new sap.ui.layout.Grid({width:"100%"});var a=new sap.m.Label({width:"100%",textAlign:"Right",layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3"}),text:{path:"/",formatter:function(){var c=this.getBindingContext().getProperty("sAggregationRole");var k=this.getBindingContext().getProperty("sKind");if(c&&k){c=s.getText(c);k=s.getText(k);var t=s.getText("dim-measure-label",[c,k]);return t+":";}}}});p.addContent(a);var P=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L4 M3 S3"}),items:{path:"aAllProperties",template:new sap.ui.core.ListItem({key:"{sName}",text:"{sName}"})},selectedKey:"{sSelectedProperty}",change:function(){s._setPropertiesFromCurrentDataset();s.oConfigurationEditor.setIsUnsaved();}});p.addContent(P);var l=new sap.m.Label({width:"100%",textAlign:"Right",layoutData:new sap.ui.layout.GridData({span:"L1 M2 S2"}),text:this.getText("label")+":"}).addStyleClass("repFormRightLabel");p.addContent(l);var i=new sap.m.Input({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L3 M2 S2"}),value:"{sLabel}",visible:{path:"sLabel",formatter:function(){if(!this.mEventRegistry.suggest){var t=new sap.apf.modeler.ui.utils.TextPoolHelper(s.oTextPool);var d={oTranslationFormat:sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL,type:"text"};t.setAutoCompleteOn(this,d);}return true;}},change:function(){var c=this.getBindingContext().getProperty("sSelectedProperty");if(c!==s.getText("none")){s._setPropertiesFromCurrentDataset();s.oConfigurationEditor.setIsUnsaved();}}});p.addContent(i);var A=new sap.ui.core.Icon({width:"100%",src:"sap-icon://add",tooltip:s.getText("addButton"),visible:{path:"nMax",formatter:function(n){return(n==="*");}},press:function(){var B=this.getBindingContext();var c=jQuery.extend(true,{},B.getObject());delete c.sSelectedProperty;delete c.sLabel;var n=parseInt(B.getPath().split("/").pop(),10);var d=s.mDataset.oPropertyDataset.aPropertyRows;d.splice(n+1,0,c);s.mModel.oPropertyModel.updateBindings();s._setPropertiesFromCurrentDataset();s.oConfigurationEditor.setIsUnsaved();}}).addStyleClass("addIconRepresentation");var r=new sap.ui.core.Icon({width:"100%",src:"sap-icon://less",tooltip:s.getText("deleteButton"),visible:{path:"/",formatter:function(){var c=true;var B=this.getBindingContext();var n=parseInt(B.getPath().split("/").pop(),10);if(n){var d=s.mDataset.oPropertyDataset.aPropertyRows;var C=d[n].sKind;var e=d[n].sAggregationRole;var f=n-1;var g=d[f].sKind;var h=d[f].sAggregationRole;c=!(C===g&&e===h);}return!c;}},press:function(){var B=this.getBindingContext();var n=parseInt(B.getPath().split("/").pop(),10);var c=s.mDataset.oPropertyDataset.aPropertyRows;c.splice(n,1);s.mModel.oPropertyModel.updateBindings();s._setPropertiesFromCurrentDataset();s.oConfigurationEditor.setIsUnsaved();}}).addStyleClass("lessIconRepresentation");var I=new sap.m.HBox({layoutData:new sap.ui.layout.GridData({span:"L1 M2 S2"}),items:[A,r]});p.addContent(I);b.bindAggregation("items","/aPropertyRows",p);},_bindSortLayoutData:function(){var s=this;var S=this.byId("idSortLayout");var o=new sap.ui.layout.Grid({width:"100%"});var a=new sap.m.Label({width:"100%",textAlign:"Right",layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3"}),text:this.getText("sortingField")+":"});o.addContent(a);var b=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L4 M3 S3"}),items:{path:"aAllProperties",template:new sap.ui.core.ListItem({key:"{sName}",text:"{sName}"})},selectedKey:"{sSortProperty}",change:function(){s._setSortFieldsFromCurrentDataset();s.oConfigurationEditor.setIsUnsaved();}});o.addContent(b);var d=new sap.m.Label({width:"100%",textAlign:"Right",layoutData:new sap.ui.layout.GridData({span:"L1 M2 S2"}),text:this.getText("direction")+":"}).addStyleClass("repFormRightLabel");o.addContent(d);var D=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L3 M2 S2"}),items:[{key:this.getText("ascending"),text:this.getText("ascending")},{key:this.getText("descending"),text:this.getText("descending")}],selectedKey:"{sDirection}",change:function(){var c=this.getBindingContext().getProperty("sSortProperty");if(c!==s.getText("none")){s._setSortFieldsFromCurrentDataset();s.oConfigurationEditor.setIsUnsaved();}}});o.addContent(D);var A=new sap.ui.core.Icon({width:"100%",src:"sap-icon://add",tooltip:this.getText("addButton"),visible:true,press:function(){var B=this.getBindingContext();var c=jQuery.extend(true,{},B.getObject());delete c.sSortProperty;delete c.sDirection;var n=parseInt(B.getPath().split("/").pop(),10);var e=s.mDataset.oSortDataset.aSortRows;e.splice(n+1,0,c);s.mModel.oSortModel.updateBindings();s._setSortFieldsFromCurrentDataset();s.oConfigurationEditor.setIsUnsaved();}}).addStyleClass("addIconRepresentation");var r=new sap.ui.core.Icon({width:"100%",src:"sap-icon://less",tooltip:this.getText("deleteButton"),visible:{path:"/",formatter:function(){var B=this.getBindingContext();var n=parseInt(B.getPath().split("/").pop(),10);return!!n;}},press:function(){var B=this.getBindingContext();var n=parseInt(B.getPath().split("/").pop(),10);var c=s.mDataset.oSortDataset.aSortRows;c.splice(n,1);s.mModel.oSortModel.updateBindings();s._setSortFieldsFromCurrentDataset();s.oConfigurationEditor.setIsUnsaved();}}).addStyleClass("lessIconRepresentation");var i=new sap.m.HBox({layoutData:new sap.ui.layout.GridData({span:"L1 M2 S2"}),items:[A,r]});o.addContent(i);S.bindAggregation("items","/aSortRows",o);},setDetailData:function(){var c=this.mParam.arguments;this.oParentStep=this.oConfigurationEditor.getStep(c.stepId);this.aSelectProperties=this._getSelectPropertiesFromParentStep();this.oRepresentation=this.oParentStep.getRepresentation(c.representationId);if(!this.oRepresentation){this.oRepresentation=this.oParentStep.createRepresentation();this._setDefaultRepresentationType();this._setDefaultProperties();this.oConfigurationEditor.setIsUnsaved();}var C=this._getChartTypeDataset();var p=this._getPropertyDataset();var s=this._getSortDataset();var o=this._getCornerTextsDataset();var a=this._getChartPictureDataset();this.mDataset={oChartTypeDataset:C,oPropertyDataset:p,oSortDataset:s,oCornerTextsDataset:o,oChartPictureDataset:a};var b=new sap.ui.model.json.JSONModel(this.mDataset.oChartTypeDataset);var P=new sap.ui.model.json.JSONModel(this.mDataset.oPropertyDataset);var S=new sap.ui.model.json.JSONModel(this.mDataset.oSortDataset);var d=new sap.ui.model.json.JSONModel(this.mDataset.oCornerTextsDataset);var e=new sap.ui.model.json.JSONModel(this.mDataset.oChartPictureDataset);this.mModel={oChartTypeModel:b,oPropertyModel:P,oSortModel:S,oCornerTextsModel:d,oChartPictureModel:e};this.byId("idChartType").setModel(this.mModel.oChartTypeModel);var f=this.sCurrentChartType;this._updateAndSetDatasetsByChartType(f);this.byId("idBasicDataLayout").setModel(this.mModel.oPropertyModel);this._bindBasicRepresentationData();this.byId("idSortLayout").setModel(this.mModel.oSortModel);this._bindSortLayoutData();this.byId("idCornerTextLayout").setModel(this.mModel.oCornerTextsModel);this.byId("idChartIcon").setModel(this.mModel.oChartPictureModel);this._addAutoCompleteFeatureOnInputs();},_insertPreviewButtonInFooter:function(){var f=this.oViewData.oFooter;f.addContentRight(this._oPreviewButton);},_removePreviewButtonFromFooter:function(){var f=this.oViewData.oFooter;f.removeContentRight(this._oPreviewButton);},_handlePreviewButtonPress:function(){var p=this._getPreviewDetails();var P=new sap.ui.view({type:sap.ui.core.mvc.ViewType.XML,viewName:"sap.apf.modeler.ui.view.previewContent",viewData:p});var o=new sap.m.Dialog({title:this.getText("preview"),content:P,endButton:new sap.m.Button({text:this.getText("close"),press:function(){o.close();}})});o.open();},onExit:function(){this._removePreviewButtonFromFooter();},_getPreviewDetails:function(){var s=this;var c=this.mDataset.oChartTypeDataset.sSelectedChartType;var S=this._getParentStepTitle();var a=this._getParentStepLongTitle()||S;var d=[],m=[];this.aSelectProperties.forEach(function(o){if(o.sAggregationRole==="dimension"){d.push(o.sName);}else if(o.sAggregationRole==="measure"){m.push(o.sName);}});var C={dimensions:[],measures:[]};this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(p){if(p.sSelectedProperty!==s.getText("none")){var A=p.sAggregationRole+"s";C[A].push({fieldDesc:p.sLabel,fieldName:p.sSelectedProperty,kind:p.sKind});}});var b=[];this.mDataset.oSortDataset.aSortRows.forEach(function(o){var f=o.sSortProperty||(o.aAllProperties.length&&o.aAllProperties[0].sName);if(f&&f!==s.getText("none")){var A=!o.sDirection||(o.sDirection===s.getText("ascending"));b.push({sSortField:f,bDescending:!A});}});var e={sLeftUpper:this.mDataset.oCornerTextsDataset.LeftUpper,sRightUpper:this.mDataset.oCornerTextsDataset.RightUpper,sLeftLower:this.mDataset.oCornerTextsDataset.LeftLower,sRightLower:this.mDataset.oCornerTextsDataset.RightLower};return{sChartType:c,sStepTitle:S,sStepLongTitle:a,aDimensions:d,aMeasures:m,oChartParameter:C,aSort:b,aCornerTexts:e};},_getParentStepLongTitle:function(){var s=this.oParentStep.getLongTitleId();s=!this.oTextPool.isInitialTextKey(s)?s:undefined;var S=s&&this.oTextPool.get(s);var a=S&&S.TextElementDescription;return a;},_getParentStepTitle:function(){var s=this.oParentStep.getTitleId();var S=s&&this.oTextPool.get(s);var a=S&&S.TextElementDescription;return a;},_getSelectPropertiesFromParentStep:function(){var a=this.oParentStep.getService();var e=this.oParentStep.getEntitySet();var E=this.getEntityTypeMetadata(a,e);var s=this.oParentStep.getSelectProperties();var r=s.map(function(p){var m=E.getPropertyMetadata(p);return{sName:p,sAggregationRole:m["aggregation-role"]};});return r;},_getCornerTextsFromConfigObject:function(c){var s=this;var C=["LeftUpper","RightUpper","LeftLower","RightLower"];var d={};C.forEach(function(a){var m=["get",a,"CornerTextKey"].join("");var b=c[m]();b=!s.oTextPool.isInitialTextKey(b)?b:undefined;var o=b&&s.oTextPool.get(b);var e=o&&o.TextElementDescription;d[a]=e;});return d;},_getChartTypeDataset:function(){var s=this;var k=Object.keys(this._getRepresentationMetadata());var c=k.map(function(K){return{sId:K,sText:s.getText(K)};});var d={aChartTypes:c,sSelectedChartType:this.oRepresentation.getRepresentationType()};this.sCurrentChartType=d.sSelectedChartType;return d;},_getChartPictureDataset:function(){var r=this.getRepresentationTypes();var d={};r.forEach(function(o){var i=o.id;d[i]=o.picture;});d.sSelectedChartPicture=d[this.oRepresentation.getRepresentationType()];return d;},_updatePictureDataset:function(c){var d=this.mModel.oChartPictureModel.getData();d.sSelectedChartPicture=d[c];},_getPropertyDataset:function(){var s=this;var p=[];var a=function(t){var g=["get",t,"s"].join("");var P=s.oRepresentation[g]();P.forEach(function(b){var l=["get",t,"TextLabelKey"].join("");var L=s.oRepresentation[l](b);var o=L&&s.oTextPool.get(L);var c=o&&o.TextElementDescription;var k=["get",t,"Kind"].join("");var K=s.oRepresentation[k](b);var C=s.oRepresentation.getRepresentationType();var r=s._getRepresentationMetadata()[C];var S=r[t.toLowerCase()+"s"].supportedKinds;var n,d;S.forEach(function(e){if(e.kind===K){n=e.min;d=e.max;}});p.push({sSelectedProperty:b,sAggregationRole:t.toLowerCase(),sLabel:c,sKind:K,nMin:n,nMax:d});});};a("Dimension");a("Measure");return{aPropertyRows:p};},_getSortDataset:function(){var s=this;var o=this.oRepresentation.getOrderbySpecifications();var a=this.aSelectProperties.slice();a.unshift({sName:this.getText("none")});if(!o.length){o.push({});}var S=o.map(function(O){var b=O.property;var c=O.ascending!==undefined&&!O.ascending?s.getText("descending"):s.getText("ascending");return{sSortProperty:b,sDirection:c,aAllProperties:a};});return{aSortRows:S};},_getCornerTextsDataset:function(){var r=this._getCornerTextsFromConfigObject(this.oRepresentation);var p=this._getCornerTextsFromConfigObject(this.oParentStep);var d=jQuery.extend({},p,r);return d;},_setDefaultRepresentationType:function(){var d;if(this.getRepresentationTypes()[0].metadata){d=this.getRepresentationTypes()[0].id;}this.oRepresentation.setRepresentationType(d);this.oRepresentation.setAlternateRepresentationType(sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION);var r=this.getText(this.oRepresentation.getRepresentationType());var s=this._getChartPictureDataset().sSelectedChartPicture;var S=this.oConfigurationEditor.getCategoriesForStep(this.oParentStep.getId());if(S.length===1){this.oViewData.updateSelectedNode({id:this.oRepresentation.getId(),icon:s});}else{var R=[];var a=jQuery.extend(true,{},this.mParam);var o={id:this.oRepresentation.getId(),aStepCategories:S,stepContext:a};this.oViewData.updateTree();}},_setDefaultProperties:function(){var f,F;this.aSelectProperties.forEach(function(s){if(!f){if(s.sAggregationRole==="dimension"){f=s.sName;}}if(!F){if(s.sAggregationRole==="measure"){F=s.sName;}}});if(f){this.oRepresentation.addDimension(f);this.oRepresentation.setDimensionKind(f,sap.apf.core.constants.representationMetadata.kind.XAXIS);}if(F){this.oRepresentation.addMeasure(F);this.oRepresentation.setMeasureKind(F,sap.apf.core.constants.representationMetadata.kind.YAXIS);}},_updateAndSetDatasetsByChartType:function(c){this._updatePropertyDatasetByChartType(c);this.mModel.oPropertyModel.updateBindings();this._setPropertiesFromCurrentDataset();this._updateSortDatasetByChartType(c);this.mModel.oSortModel.updateBindings();this._setSortFieldsFromCurrentDataset();this._updatePictureDataset(c);this.mModel.oChartPictureModel.updateBindings();},_updatePropertyDatasetByChartType:function(c){var s=this;var d={aPropertyRows:[]};var r=this._getRepresentationMetadata()[c];var a=["dimensions","measures"];a.forEach(function(A){if(r.hasOwnProperty(A)){var S=r[A].supportedKinds;S.forEach(function(o){var p={sAggregationRole:A.slice(0,-1),sKind:o.kind,nMin:o.min,nMax:o.max,aAllProperties:s.aSelectProperties.filter(function(P){return(P.sAggregationRole===(A.slice(0,-1)));})};if(!parseInt(o.min,10)){p.aAllProperties.unshift({sName:s.getText("none"),sAggregationRole:A.slice(0,-1)});}d.aPropertyRows.push(p);});}});var R={aPropertyRows:[]};d.aPropertyRows.forEach(function(D){var e=false;s.mDataset.oPropertyDataset.aPropertyRows.forEach(function(E){var h=E.sAggregationRole===D.sAggregationRole;var H=E.sKind===D.sKind;var b=E.nMin===D.nMin;var f=E.nMax===D.nMax;if(h&&H&&b&&f){e=true;var C=jQuery.extend(E,D);R.aPropertyRows.push(C);}});if(!e){R.aPropertyRows.push(D);}});this.mDataset.oPropertyDataset.aPropertyRows=R.aPropertyRows;},_updateSortDatasetByChartType:function(c){var r=this._getRepresentationMetadata()[c];if(r.sortable!==undefined&&!r.sortable){var a=this.aSelectProperties.slice();a.unshift({sName:this.getText("none")});this.mDataset.oSortDataset.aSortRows=[{aAllProperties:a,sDirection:this.getText("ascending")}];this.byId("idSortLayout").setVisible(false);this.byId("idSorting").setVisible(false);}else{this.byId("idSortLayout").setVisible(true);this.byId("idSorting").setVisible(true);this.mModel.oSortModel.updateBindings();var s=this.byId("idSortLayout");jQuery.sap.delayedCall(10,s,s.rerender);}},_setPropertiesFromCurrentDataset:function(){var s=this;var d=this.oRepresentation.getDimensions();d.forEach(function(D){s.oRepresentation.removeDimension(D);});var m=this.oRepresentation.getMeasures();m.forEach(function(M){s.oRepresentation.removeMeasure(M);});this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(p){var S=p.sSelectedProperty||(p.aAllProperties.length&&p.aAllProperties[0].sName);if(S&&S!==s.getText("none")){var a=p.sAggregationRole;var A=[a.charAt(0).toUpperCase(),a.substring(1)].join("");var l=p.sLabel;var t=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL;var L=s.oTextPool.setText(l,t);var b=["add",A].join("");var c=["set",A,"Kind"].join("");var e=["set",A,"TextLabelKey"].join("");s.oRepresentation[b](S);s.oRepresentation[c](S,p.sKind);s.oRepresentation[e](S,L);}});},_setSortFieldsFromCurrentDataset:function(){var s=this;this.oRepresentation.getOrderbySpecifications().forEach(function(o){s.oRepresentation.removeOrderbySpec(o.property);});this.mDataset.oSortDataset.aSortRows.forEach(function(S){var a=S.sSortProperty||(S.aAllProperties.length&&S.aAllProperties[0].sName);if(a&&a!==s.getText("none")){var A=!S.sDirection||(S.sDirection===s.getText("ascending"));s.oRepresentation.addOrderbySpec(a,A);}});},_getRepresentationMetadata:function(){var r={};this.getRepresentationTypes().forEach(function(a){if(a.metadata){r[a.id]=a.metadata;}});return r;}});
