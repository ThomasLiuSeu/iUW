/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.configurationObjects");(function(){'use strict';sap.apf.modeler.core.ConfigurationObjects=function(i){var t=this;var H,a,p,m;if(i.constructor.hashtable){H=i.constructor.hashtable;}if(i.instance.textPool){a=i.instance.textPool;}if(i.instance.persistenceProxy){p=i.instance.persistenceProxy;}if(i.instance.messageHandler){m=i.instance.messageHandler;}function c(h,j){var P=[];if(j){P.push(j);}m.putMessage(m.createMessageObject({code:h,aParameters:P}));}function b(l){var r=l&&l.type&&l.type==="label"&&l.kind&&l.kind==="text"&&l.key&&typeof l.key==="string";if(!r){c(11030,l.key);}return r;}this.serializeLabelKey=function(h){return{type:"label",kind:"text",key:a.getPersistentKey(h)};};this.serializeAndAddThumbnail=function(h,j){var l=h.getLeftLowerCornerTextKey();var k=h.getLeftUpperCornerTextKey();var r=h.getRightUpperCornerTextKey();var n=h.getRightLowerCornerTextKey();var o={type:"thumbnail"};if(k){o.leftUpper=this.serializeLabelKey(k);}if(l){o.leftLower=this.serializeLabelKey(l);}if(r){o.rightUpper=this.serializeLabelKey(r);}if(n){o.rightLower=this.serializeLabelKey(n);}if(o.leftLower||o.leftUpper||o.rightLower||o.rightUpper){j.thumbnail=o;}};this.serializeCategory=function(h,j){var T=a.get(h.labelKey);var k=[];if(j){j.forEach(function(n){k.push({type:"step",id:n});});}var l=(T&&T.TextElementDescription)||"";return{type:"category",description:l,id:h.getId(),label:t.serializeLabelKey(h.labelKey),steps:k};};this.validateCategory=function(h){var r=h&&h.type&&h.type==="category"&&h.id&&h.steps&&b(h.label);if(r){h.steps.forEach(function(o){if(!o.type||o.type!=="step"||!o.id){r=false;}});}if(!r){c(11031,h.id);}return r;};this.validateRequest=function(r){var h=r&&r.id&&r.type==="request"&&r.service&&typeof r.service==="string"&&((r.entityType&&typeof r.entityType==="string")||(r.entitySet&&typeof r.entitySet==="string"))&&r.selectProperties&&r.selectProperties&&r.selectProperties instanceof Array&&r.selectProperties.length>=0;if(!h){c(11032,r.id);}return h;};this.validateBinding=function(h){var r=h&&h.id&&h.type==="binding"&&h.requiredFilters&&h.requiredFilters instanceof Array&&h.requiredFilters.length>=0&&h.representations&&h.representations instanceof Array;if(!r){c(11033,h.id);}return r;};this.validateFacetFilter=function(h){var r=h&&h.id&&h.property&&h.type==="facetFilter";if(!r){c(11034,h.id);}return r;};this.validateNavigationTarget=function(n){var r=n&&n.id&&n.semanticObject&&n.action&&n.type==="navigationTarget";if(!r){c(11040,n.id);}return r;};this.validateStep=function(h){var r=h&&h.id&&h.type==="step"&&b(h.title)&&b(h.longTitle);if(!r){c(11035,h.id);}return r;};this.validateConfiguration=function(h){var r=h&&h.applicationTitle&&h.applicationTitle.key&&typeof h.applicationTitle.key==='string'&&h.steps&&h.steps instanceof Array&&h.steps.length>=0&&h.requests&&h.requests instanceof Array&&h.requests.length>=0&&h.bindings&&h.bindings instanceof Array&&h.bindings.length>=0&&h.representationTypes&&h.representationTypes instanceof Array&&h.representationTypes.length>=0&&h.facetFilters&&h.facetFilters instanceof Array&&h.facetFilters.length>=0&&h.categories&&h.categories instanceof Array&&h.categories.length>=0;if(!r){c(11036);}return r;};function s(h){var r=[];var j,k;var l,n;var o;var q;var u=h.getRepresentations();u.forEach(function(v){j=[];k=v.getDimensions();k.forEach(function(w){var x={fieldName:w};if(v.getDimensionKind(w)){x.kind=v.getDimensionKind(w);}if(v.getDimensionTextLabelKey(w)){x.fieldDesc={type:'label',kind:'text',key:v.getDimensionTextLabelKey(w)};}j.push(x);});l=[];n=v.getMeasures();n.forEach(function(w){var x={fieldName:w};if(v.getMeasureKind(w)){x.kind=v.getMeasureKind(w);}if(v.getMeasureTextLabelKey(w)){x.fieldDesc={type:'label',kind:'text',key:v.getMeasureTextLabelKey(w)};}l.push(x);});o=[];v.getOrderbySpecifications().forEach(function(w){o.push({property:w.property,ascending:w.ascending});});q={id:v.getId(),representationTypeId:v.getRepresentationType(),parameter:{dimensions:j,measures:l,alternateRepresentationTypeId:v.getAlternateRepresentationType()}};if(v.getWidthProperties()){q.parameter.width=v.getWidthProperties();}if(o.length>0){q.parameter.orderby=o;}t.serializeAndAddThumbnail(v,q);r.push(q);});return r;}this.serializeBinding=function(h,j){var k="binding-for-"+h.getId();var T=a.get(h.getTitleId());var l=(T&&T.TextElementDescription)||"";j.bindings.push({type:"binding",id:k,stepDescription:l,requiredFilters:h.getFilterProperties(),representations:s(h)});return k;};this.serializeRequest=function(h,j){var r;var k="request-for-"+h.getId();r={type:"request",id:k,service:h.getService(),entitySet:h.getEntitySet(),selectProperties:h.getSelectProperties()};j.requests.push(r);return k;};this.serializeFilterMappingRequest=function(h,j){var r="request-for-FilterMapping"+h.getId();var k={type:"request",id:r,service:h.getFilterMappingService(),entitySet:h.getFilterMappingEntitySet(),selectProperties:h.getFilterMappingTargetProperties()};j.requests.push(k);return r;};this.serializeStep=function(h,j){var r=t.serializeRequest(h,j);var k=t.serializeBinding(h,j);var T=a.get(h.getTitleId());var l=(T&&T.TextElementDescription)||"";var n=h.getLongTitleId();var o={type:"step",description:l,request:r,binding:k,id:h.getId(),title:t.serializeLabelKey(h.getTitleId())};if(h.getFilterMappingService()){o.filterMapping={requestForMappedFilter:t.serializeFilterMappingRequest(h,j),target:h.getFilterMappingTargetProperties(),keepSource:h.getFilterMappingKeepSource()?"true":"false"};}if(n!==""&&n!==undefined){o.longTitle=t.serializeLabelKey(h.getLongTitleId());}this.serializeAndAddThumbnail(h,o);return o;};this.serializeFacetFilter=function(h,j){var r,k;if(h.getServiceOfFilterResolution()){r=n("FilterResolution",h,j);}if(h.getServiceOfValueHelp()){k=n("ValueHelp",h,j);}var T=a.get(h.getLabelKey());var l=(T&&T.TextElementDescription)||"";return{type:"facetFilter",description:l,id:h.getId(),alias:h.getAlias(),property:h.getProperty(),multiSelection:h.isMultiSelection()+"",preselectionFunction:h.getPreselectionFunction(),preselectionDefaults:h.getPreselectionDefaults(),label:t.serializeLabelKey(h.getLabelKey()),filterResolutionRequest:r,valueHelpRequest:k};function n(o,h,j){var q;var u;var v;var w;switch(o){case"ValueHelp":u=h.getServiceOfValueHelp();v=h.getEntitySetOfValueHelp();w=h.getSelectPropertiesOfValueHelp();break;case"FilterResolution":u=h.getServiceOfFilterResolution();v=h.getEntitySetOfFilterResolution();w=h.getSelectPropertiesOfFilterResolution();break;}var x=o+"-request-for-"+h.getId();q={type:"request",id:x,service:u,entitySet:v,selectProperties:w};j.requests.push(q);return x;}};this.serializeNavigationTarget=function(n){return{type:"navigationTarget",id:n.getId(),semanticObject:n.getSemanticObject(),action:n.getAction()};};this.serializeConfiguration=function(h){var j={applicationTitle:t.serializeLabelKey(h.getApplicationTitle()),steps:[],requests:[],bindings:[],representationTypes:[],categories:[],facetFilters:[],navigationTargets:[]};var k={requests:j.requests,bindings:j.bindings};h.getCategories().forEach(function(l){var n=h.getCategoryStepAssignments(l.getId());j.categories.push(t.serializeCategory(l,n));});h.getSteps().forEach(function(l){var n=t.serializeStep(l,k);j.steps.push(n);});h.getFacetFilters().forEach(function(l){var n=t.serializeFacetFilter(l,k);j.facetFilters.push(n);});h.getNavigationTargets().forEach(function(n){var l=t.serializeNavigationTarget(n);j.navigationTargets.push(l);});return j;};function d(h,j){var k=h.thumbnail;if(!k){return;}if(k.leftLower){j.setLeftLowerCornerTextKey(k.leftLower.key);}if(k.leftUpper){j.setLeftUpperCornerTextKey(k.leftUpper.key);}if(k.rightLower){j.setRightLowerCornerTextKey(k.rightLower.key);}if(k.rightUpper){j.setRightUpperCornerTextKey(k.rightUpper.key);}}function e(h,r,j){var k=j.createStepWithId(h.id);var l=j.getStep(k);var n=r.getItem(h.request);if(n.entityType){n.entitySet=n.entityType;delete n.entityType;}if(n.service){j.registerService(n.service);}l.setService(n.service);l.setEntitySet(n.entitySet);l.setTitleId(h.title.key);if(h.longTitle&&h.longTitle.key){l.setLongTitleId(h.longTitle.key);}d(h,l);n.selectProperties.forEach(function(u){l.addSelectProperty(u);});var o=r.getItem(h.binding);o.requiredFilters.forEach(function(u){l.addFilterProperty(u);});o.representations.forEach(function(u){var v;var w=l.getRepresentation(l.createRepresentation().getId());w.setRepresentationType(u.representationTypeId);w.setAlternateRepresentationType(u.parameter.alternateRepresentationTypeId);u.parameter.dimensions.forEach(function(x){w.addDimension(x.fieldName);if(x.fieldDesc){w.setDimensionTextLabelKey(x.fieldName,x.fieldDesc.key);}if(x.kind){w.setDimensionKind(x.fieldName,x.kind);}});u.parameter.measures.forEach(function(x){w.addMeasure(x.fieldName);if(x.fieldDesc){w.setMeasureTextLabelKey(x.fieldName,x.fieldDesc.key);}if(x.kind){w.setMeasureKind(x.fieldName,x.kind);}});if(u.parameter.width){for(v in u.parameter.width){if(u.parameter.width.hasOwnProperty(v)){w.setWidthProperty(v,u.parameter.width[v]);}}}if(u.parameter.orderby){u.parameter.orderby.forEach(function(x){w.addOrderbySpec(x.property,x.ascending);});}d(u,w);});if(h.filterMapping){var q=r.getItem(h.filterMapping.requestForMappedFilter);if(q.entityType){q.entitySet=q.entityType;delete q.entityType;}l.setFilterMappingService(q.service);l.setFilterMappingEntitySet(q.entitySet);h.filterMapping.target.forEach(function(u){l.addFilterMappingTargetProperty(u);});if(h.filterMapping.keepSource==="true"){l.setFilterMappingKeepSource(true);}else{l.setFilterMappingKeepSource(false);}}}function f(h,r,j){var k=j.createFacetFilterWithId(h.id);var l=j.getFacetFilter(k);l.setLabelKey(h.label.key);l.setAlias(h.alias);l.setProperty(h.property);l.setPreselectionFunction(h.preselectionFunction);l.setPreselectionDefaults(h.preselectionDefaults);if(h.multiSelection==="true"){l.setMultiSelection(true);}if(h.valueHelpRequest){var n=r.getItem(h.valueHelpRequest);if(n.entityType){n.entitySet=n.entityType;delete n.entityType;}if(n.service){j.registerService(n.service);l.setServiceOfValueHelp(n.service);}if(n.entitySet){l.setEntitySetOfValueHelp(n.entitySet);}n.selectProperties.forEach(function(q){l.addSelectPropertyOfValueHelp(q);});}if(h.filterResolutionRequest){var o=r.getItem(h.filterResolutionRequest);if(o.entityType){o.entitySet=o.entityType;delete o.entityType;}if(o.service){j.registerService(o.service);l.setServiceOfFilterResolution(o.service);}if(o.entitySet){l.setEntitySetOfFilterResolution(o.entitySet);}o.selectProperties.forEach(function(q){l.addSelectPropertyOfFilterResolution(q);});}}function g(h,j){var k=j.createNavigationTargetWithId(h.id);var l=j.getNavigationTarget(k);l.setSemanticObject(h.semanticObject);l.setAction(h.action);}this.mapToDesignTime=function(r,h){h.setApplicationTitle(r.getItem('applicationTitle').key);r.getSteps().forEach(function(j){e(j,r,h);});r.getCategories().forEach(function(j){h.createCategoryWithId({labelKey:j.label.key},j.id);j.steps.forEach(function(k){h.addCategoryStepAssignment(j.id,k.id);});});r.getFacetFilters().forEach(function(j){f(j,r,h);});r.getNavigationTargets().forEach(function(n){g(n,h);});};this.loadAllConfigurations=function(h,j){var k=new sap.apf.core.utils.Filter(m,'Application','eq',h);p.readCollection("configuration",function(r,l,n){j(r,l,n);},undefined,undefined,k,true);};this.getTextKeysFromAllConfigurations=function(h,j){this.loadAllConfigurations(h,function(k,l,n){var o=new H(m);if(n){j(undefined,n);return;}k.forEach(function(q){var r=JSON.parse(q.SerializedAnalyticalConfiguration);var u=sap.apf.modeler.core.ConfigurationObjects.getTextKeysFromConfiguration(r);u.forEach(function(v){o.setItem(v,v);});});j(o,undefined);});};};sap.apf.modeler.core.ConfigurationObjects.deepDataCopy=function deepDataCopy(i){var r;if(!i){r=i;}else if(i.copy&&typeof i.copy==="function"){r=i.copy();}else if(i&&typeof i==="object"){if(i instanceof Array){r=[];i.forEach(function(a){r.push(deepDataCopy(a));});}else{r={};for(var a in i){if(!i.hasOwnProperty(a)){continue;}r[a]=deepDataCopy(i[a]);}}}else{r=i;}return r;};sap.apf.modeler.core.ConfigurationObjects.getTextKeysFromConfiguration=function getTextKeysFromConfiguration(c){var r=[];if(!c){return;}if(c.type&&c.type==="label"&&c.kind&&c.kind==="text"&&c.key){return[c.key];}else{for(var i in c){if(typeof c[i]!=="object"||!c.hasOwnProperty(i)){continue;}Array.prototype.push.apply(r,getTextKeysFromConfiguration(c[i]));}return r;}};}());
