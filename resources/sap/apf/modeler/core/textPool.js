/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.textPool");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.ui.core.format.DateFormat");(function(){'use strict';sap.apf.modeler.core.TextPool=function(c,d,e){var m=c.instance.messageHandler;var p=c.instance.persistenceProxy;var H=c.constructor.hashtable;var h=new H(m);var k=new H(m);var g=new H(m);var f;var l=0;var n={TextElement:sap.apf.core.constants.textKeyForInitialText,Language:sap.apf.core.constants.developmentLanguage,TextElementType:"XFLD",TextElementDescription:"",MaximumLength:10,Application:d,TranslationHint:""};function o(t,a){var b=h.getKeys();var i,j=b.length;var u=a.MaximumLength||10;var v=a.TranslationHint||"";var w;for(i=0;i<j;i++){w=h.getItem(b[i]);if((w.TextElementDescription===t)&&(w.MaximumLength===u)&&(w.TranslationHint===v)){return b[i];}}return undefined;}function r(){var t=d.toLowerCase();var a=/^[0-9a-f]+$/;var i=a.test(t);if(!i||d.length!==32){m.putMessage(m.createMessageObject({code:"11009",aParameters:[d]}));t="<please enter valid translation uuid, if you want to upload into a SAP translation system>";}else{t=t.substring(0,8)+'-'+t.substring(8,12)+'-'+t.substring(12,16)+'-'+t.substring(16,20)+'-'+t.substring(20);}return"#FIORI: insert Fiori-Id\n"+"# __ldi.translation.uuid="+t+"\n"+"#ApfApplicationId="+d+"\n\n";}function q(t){var a,D;if(!f&&(!t.TextElementType||!t.MaximumLength)){f=true;m.putMessage(m.createMessageObject({code:"11008",aParameters:[t.TextElement]}));}var b="#"+(t.TextElementType||"<Add text type>")+","+(t.MaximumLength||"<Add maximum length>");if(t.TranslationHint&&t.TranslationHint!==""){b=b+':'+t.TranslationHint;}b=b+"\n"+t.TextElement+"="+t.TextElementDescription+"\n";var i=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy/MM/dd HH:mm:ss"});if(t.LastChangeUTCDateTime&&t.LastChangeUTCDateTime!==""){a=t.LastChangeUTCDateTime.replace(/\/Date\(/,'').replace(/\)\//,'');D=new Date(parseInt(a,10));}else{D=new Date();}b=b+"# LastChangeDate="+i.format(D)+'\n\n';return b;}this.removeTexts=function(t,a){var b=[];var i,u;function v(w){var j;if(!w){for(j=0;j<u;j++){h.removeItem(t[j]);}}a(w);}u=t.length;if(u===0){a(undefined);return;}for(i=0;i<u;i++){if(t[i]===sap.apf.core.constants.textKeyForInitialText){continue;}b.push({method:"DELETE",entitySetName:"texts",inputParameters:[{name:'TextElement',value:t[i]},{name:'Language',value:sap.apf.core.constants.developmentLanguage}]});}p.doChangeOperationsInBatch(b,v);};this.isInitialTextKey=function(t){return(t===sap.apf.core.constants.textKeyForInitialText);};this.addTextsAndSave=function(t,a){function b(z,A){return(z.TextElement===A.TextElement&&z.TextElementDescription===A.TextElementDescription&&z.MaximumLength===A.MaximumLength&&z.Language===A.Language&&z.TranslationHint===A.TranslationHint);}var i;var j=t.length;var u;var v=[];var w=[];var x=[];var y;for(i=0;i<j;i++){if(t[i]===sap.apf.core.constants.textKeyForInitialText){continue;}u=h.getItem(t[i].TextElement);if(u){if(!b(u,t[i])){v.push(t[i]);h.setItem(t[i].TextElement,t[i]);}}else{w.push(t[i]);h.setItem(t[i].TextElement,t[i]);}}j=v.length;for(i=0;i<j;i++){y=[{name:'TextElement',value:v[i].TextElement},{name:'Language',value:v[i].Language}];v[i].MaximumLength=parseInt(v[i].MaximumLength,10);x.push({method:"PUT",entitySetName:"texts",data:v[i],inputParameters:y});}j=w.length;for(i=0;i<j;i++){w[i].MaximumLength=parseInt(w[i].MaximumLength,10);x.push({method:"POST",entitySetName:"texts",data:w[i]});}if(x.length>0){p.doChangeOperationsInBatch(x,a);}else{a(undefined);}};this.exportTexts=function(){var t=r();var i,j;f=false;var u=h.getKeys();u.sort(function(a,b){var v=h.getItem(a);var w=h.getItem(b);if(v.LastChangeUTCDateTime<w.LastChangeUTCDateTime){return-1;}if(v.LastChangeUTCDateTime>w.LastChangeUTCDateTime){return 1;}return 0;});j=u.length;for(i=0;i<j;i++){t=t+q(h.getItem(u[i]));}return t;};this.get=function(i){var a,b;if(i===sap.apf.core.constants.textKeyForInitialText){return n;}if(h.hasItem(i)){return h.getItem(i);}if(k.hasItem(i)){a=k.getItem(i);if(a.TextElementDescription){return a;}return h.getItem(a);}b=jQuery.extend({},true,n);b.TextElement=i;b.TextElementDescription=i;return b;};this.getPersistentKey=function(i){return i;};this.setText=function(t,a){var b;var i;var u=function(v,w,x){if(x){m.putMessage(x);}if(v){h.setItem(v.TextElement,v);i=v.TextElement;}};var j={TextElement:"",Language:sap.apf.core.constants.developmentLanguage,TextElementType:a.TextElementType,TextElementDescription:t,MaximumLength:a.MaximumLength||10,Application:d,TranslationHint:a.TranslationHint||""};if(!t){return sap.apf.core.constants.textKeyForInitialText;}i=o(t,a);if(i){return i;}l++;b="textKey"+l;p.create('texts',j,u,false);return i;};this.getTextKeys=function(t){var a=h.getKeys();var i,b,j=a.length;var u=[];for(i=0;i<j;i++){b=h.getItem(a[i]);if(t&&b.TextElementType!==t){continue;}if(g.hasItem(a[i])){u.push(g.getItem(a[i]));}else{u.push(a[i]);}}return u;};this.getTextsByTypeAndLength=function(t,a){var b=h.getKeys();var i,j,u=b.length;var v=[];for(i=0;i<u;i++){j=h.getItem(b[i]);if(j.TextElementType===t&&j.MaximumLength===a){if(g.hasItem(b[i])){v.push({TextElement:g.getItem(b[i]),TextElementDescription:j.TextElementDescription});}else{v.push({TextElement:b[i],TextElementDescription:j.TextElementDescription});}}}return v;};function s(){var i,a;a=e.length;for(i=0;i<a;i++){h.setItem(e[i].TextElement,e[i]);}}s();};}());
