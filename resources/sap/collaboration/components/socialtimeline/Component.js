/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.ui.core.UIComponent");jQuery.sap.require("sap.suite.ui.commons.Timeline");jQuery.sap.require("sap.suite.ui.commons.TimelineItem");jQuery.sap.require("sap.collaboration.components.socialtimeline.controls.TimelineEntryControl");jQuery.sap.require("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler");jQuery.sap.require("sap.collaboration.components.socialtimeline.datahandlers.SMIntegrationDataHandler");jQuery.sap.require("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler");jQuery.sap.require("sap.collaboration.components.utils.CommonUtil");jQuery.sap.declare("sap.collaboration.components.socialtimeline.Component");sap.ui.core.UIComponent.extend("sap.collaboration.components.socialtimeline.Component",{metadata:{version:"1.0",dependencies:{libs:[],components:[],ui5version:""},config:{},customizing:{},rootView:null,publicMethods:["setBusinessObjectKey","setBusinessObjectMap","updateTimelineEntry","deleteTimelineEntry"],aggregations:{},properties:{"enableSocial":{type:"boolean",group:"Misc",defaultValue:true},"alignment":{type:"sap.suite.ui.commons.TimelineAlignment",group:"Misc",defaultValue:sap.suite.ui.commons.TimelineAlignment.Right},"axisOrientation":{type:"sap.suite.ui.commons.TimelineAxisOrientation",group:"Misc",defaultValue:sap.suite.ui.commons.TimelineAxisOrientation.Vertical},"noDataText":{type:"string",group:"Misc",defaultValue:null},"showIcons":{type:"boolean",group:"Misc",defaultValue:true},"visible":{type:"boolean",group:"Appearance",defaultValue:true},"width":{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:'100%'},"customFilter":{type:"object",group:"Misc"}},events:{"customActionPress":{}}},_defaultAttributes:{collaborationHostServiceUrl:"/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData",smiServiceUrl:"/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV",pageSize:10},init:function(){this._oLogger=jQuery.sap.log.getLogger("sap.collaboration.components.socialtimeline.Component");this._oCollabHostModel;this._oSMIntegrationModel;this._oTimeline;this._oTimelineModelData={timelineData:[],filterData:[],suggestions:[]};this._oTimelineModel=new sap.ui.model.json.JSONModel(this._oTimelineModelData);this._iGrowingThreshold=this._defaultAttributes.pageSize;this._oFilter={"backend":undefined,"jam":undefined};this._oBusinessObjectMap={};this._sBusinessObjectKey=undefined;this._oCommonUtil=new sap.collaboration.components.utils.CommonUtil();this._oLanguageBundle=this._oCommonUtil.getLanguageBundle();this._oTimelineDataHandler;this._oJamDataHandler;this._oSocialProfile;this._oTimelineUser={};this._bEnableSocial;this._initialize();sap.ui.core.UIComponent.prototype.init.apply(this);},exit:function(){},onBeforeRendering:function(){this._oLogger.info("Creating Timeline Control with parameters");this._oLogger.info("enableSocial: "+this.getEnableSocial());this._oLogger.info("alignment: "+this.getAlignment());this._oLogger.info("axisOrientation: "+this.getAxisOrientation());this._oLogger.info("noDataText: "+this.getNoDataText());this._oLogger.info("showIcons: "+this.getShowIcons());this._oLogger.info("visible: "+this.getVisible());this._oLogger.info("width: "+this.getWidth());this._validateInputParameters();if(this._bEnableSocial===undefined){this._setEnableSocial();}this._oTimeline.setEnableSocial(this._bEnableSocial);this._oTimeline.setAlignment(this.getAlignment());this._oTimeline.setAxisOrientation(this.getAxisOrientation());this._oTimeline.setEnableBackendFilter(true);this._oTimeline.setEnableScroll(false);this._oTimeline.setForceGrowing(true);this._oTimeline.setGrowingThreshold(this._iGrowingThreshold);this._oTimeline.setNoDataText(this.getNoDataText());this._oTimeline.setShowIcons(this.getShowIcons());this._oTimeline.setVisible(this.getVisible());this._oTimeline.setWidth(this.getWidth());this._oTimeline.setShowHeaderBar(false);this._getLoggedInUser();this._setTimelineModel();this._buildFilter();},onAfterRendering:function(){},createContent:function(){return this._createTimeline();},setBusinessObjectMap:function(b){this._oLogger.info("servicePath: "+b.servicePath);this._oLogger.info("collection: "+b.collection);this._oLogger.info("applicationContext: "+b.applicationContext);if(this._bEnableSocial===undefined){this._setEnableSocial();}this._oBusinessObjectMap=b;if(this._oBusinessObjectMap.customActionCallback&&typeof(this._oBusinessObjectMap.customActionCallback)!=='function'){this._oLogger.error("The property customActionCallback is not a function.");this.destroy();}this._oTimelineDataHandler=new sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler(this._oBusinessObjectMap,this._oJamDataHandler,this._oSMIntegrationModel,this._iGrowingThreshold,this._bEnableSocial);},setBusinessObjectKey:function(k){this._oLogger.info("Business Object Key: "+k);if(!this._oTimelineDataHandler){this._oLogger.error("Function setBusinessObjectMap must be called before calling setBusinessObjectKey for the first time.");}this._sBusinessObjectKey=k;this._oTimelineDataHandler.setBusinessObjectKey(k);this._refreshTimelineModel();this._oTimeline.setShowHeaderBar(true);},updateTimelineEntry:function(t,I){var T=sap.ui.getCore().byId(I);var e=T.getAggregation('embeddedControl');var f=e._oFlexbox.getItems();f[0].setText(t);if(f.length>1){for(var i=1;i<f.length;i++){f[i].destroy();}}var s=T.getBindingContext().getPath();var o=T.getModel();o.getProperty(s).timelineItemData.text=t;o.getProperty(s).timelineItemData.timelineEntryDetails=[];},deleteTimelineEntry:function(i){var t=sap.ui.getCore().byId(i);var T=t.getBindingContext().getPath();var o=t.getModel();var a=o.getProperty(T);var b=o.getData().timelineData.indexOf(a);o.getData().timelineData.splice(b,1);t.destroy();},_setEnableSocial:function(){if(this._checkJamConfiguration()){this._bEnableSocial=this.getEnableSocial();}else{this._bEnableSocial=false;}},_checkJamConfiguration:function(){var s=true;var a=this;var S=function(c){if(c===false){s=false;}};var e=function(E){a._oCommonUtil.displayError();};this._oSMIntegrationDataHandler=new sap.collaboration.components.socialtimeline.datahandlers.SMIntegrationDataHandler(this._oSMIntegrationModel);this._oSMIntegrationDataHandler.getJamConfigurationStatus(S,e);return s;},_initialize:function(){var a=true;if(!this._oCollabHostModel){this._oCollabHostModel=new sap.ui.model.odata.ODataModel(this._defaultAttributes.collaborationHostServiceUrl,a);}if(!this._oSMIntegrationModel){this._oSMIntegrationModel=new sap.ui.model.odata.ODataModel(this._defaultAttributes.smiServiceUrl,a);}if(!this._oJamDataHandler){this._oJamDataHandler=new sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler(this._oCollabHostModel);}},_createTimeline:function(){this._oTimeline=new sap.suite.ui.commons.Timeline(this.getId()+"_timeline",{data:[],filterSelectionChange:this._onFilterSelectionChange.bind(this),grow:this._onGrow.bind(this),addPost:this._onAddPost.bind(this),suggest:this._onSuggest.bind(this)});return this._oTimeline;},_refreshTimelineModel:function(){var s=this;this._oTimeline.setBusyIndicatorDelay(0).setBusy(true);this._oTimelineDataHandler.getTimelineData(this._oFilter).then(function(t){s._oTimeline.setBusy(false);s._oTimelineModelData.timelineData=t;s._oTimelineModel.setData(s._oTimelineModelData);s._hideReplyFromJamBarInTLItems();},function(e){s._oCommonUtil.displayError();s._oTimeline.setBusy(false);});},_setTimelineModel:function(){var c=new sap.ui.core.CustomData({key:"{key}",value:"{value}"});var t=new sap.suite.ui.commons.TimelineItem({dateTime:"{timelineItemData/dateTime}",userName:"{timelineItemData/userName}",title:"{timelineItemData/title}",icon:"{timelineItemData/icon}",filterValue:"{timelineItemData/filterValue}",userNameClickable:this._bEnableSocial,userNameClicked:this._onUserNameClicked,userPicture:"{timelineItemData/userPicture}",embeddedControl:this._createEmbeddedControl(),customAction:{template:c,path:"timelineItemData/customActionData"},customActionClicked:this._onCustomActionClicked.bind(this),replyCount:"{_feedEntryData/RepliesCount}",replyListOpen:this._onReplyListOpen.bind(this),replyList:new sap.m.List({showNoData:false,width:"20rem"}),replyPost:this._onReplyPost.bind(this),suggest:this._onSuggest.bind(this)});this._oTimeline.setModel(this._oTimelineModel);this._oTimeline.bindAggregation("content",{path:"/timelineData",template:t});var f=new sap.suite.ui.commons.TimelineFilterListItem({key:"{key}",text:"{text}"});this._oTimeline.bindAggregation("filterList",{path:"/filterData",template:f});},_createEmbeddedControl:function(){return new sap.collaboration.components.socialtimeline.controls.TimelineEntryControl(this.getId()+"_embeddedControl",{timelineEntry:"{timelineItemData}"});},_buildFilter:function(){var f=[];var d=[{key:0,text:this._oCommonUtil.getLanguageBundle().getText('TE_FILTER_DISCUSSION_POSTS'),value:""},{key:1,text:this._oCommonUtil.getLanguageBundle().getText('TE_FILTER_SYSTEM_UPDATES'),value:""}];if(this._bEnableSocial===false){for(var i=0;i<d.length;i++){if(d[i].text===this._oCommonUtil.getLanguageBundle().getText('TE_FILTER_DISCUSSION_POSTS')){d.splice(i,1);break;}}}var c=this.getCustomFilter();var C=d.length;if(c){for(var i=0;i<c.length;i++){c[i].key=C;C++;}}f=d.concat(c);this._setFilterData(f);},_setFilterData:function(f){this._oTimelineModelData.filterData=this._oTimelineModelData.filterData.concat(f);this._oTimelineModel.setData(this._oTimelineModelData);},_hideReplyFromJamBarInTLItems:function(){var s=this;var t=this._oTimeline.getContent();t.forEach(function(T){var o=T.getBindingContext().getObject();if(!o._feedEntryData){s._hideReply(T);}});},_hideReply:function(t){t._replyLink.setVisible(false);},_getFeedId:function(t){var p=t.getBindingContext().getPath();var P=p.split("/");var s=P[P.length-1];var f=t.getModel().getData().timelineData[s]._feedEntryData.Id;return f;},_getLoggedInUser:function(){var s=this;var g=this._oJamDataHandler.getSender();g.promise.done(function(j,r){s._oTimelineUser=j;});g.promise.fail(function(e){s._oLogger.error('Failed to get the sender',e.stack);});},_onGrow:function(){var s=this;this._oTimelineDataHandler.getTimelineData(this._oFilter).then(function(t){var d=s._oTimelineModel.getData();d.timelineData=d.timelineData.concat(t);s._oTimelineModel.setData(d);s._hideReplyFromJamBarInTLItems();},function(e){s._oCommonUtil.displayError();});},_onFilterSelectionChange:function(e){this._oFilter={"backend":undefined,"jam":undefined};this._oTimelineDataHandler.reset();var s=e.getParameter('selectedItem');if(s.getProperty('key')){var S=parseInt(s.getProperty('key'));switch(S){case 0:this._oFilter.jam=this._oTimelineDataHandler.constants.FILTER_JAM_ALL;break;case 1:this._oFilter.backend=this._oTimelineDataHandler.constants.FILTER_BACKEND_ALL;break;default:var f=this._oTimelineModelData.filterData;var n=f.length;var N=this.getCustomFilter().length;var I=n-N;for(var i=I;i<f.length;i++){if(S==f[i].key){this._oFilter.backend=f[i].value;break;}}}}this._refreshTimelineModel();},_onUserNameClicked:function(c){var s=c.getSource().getParent().getParent();if(!s._oSocialProfile){s._oSocialProfile=sap.ui.getCore().createComponent({name:"sap.collaboration.components.socialprofile",id:this.getId()+"_socialProfile"});s._oSocialProfile._defaultAttributes=s._defaultAttributes;}var S={openingControl:c.getSource()._userNameLink,memberId:c.getSource().getBindingContext().getObject().timelineItemData.userEmail};S.memberInfo=s._oTimelineDataHandler.getUserInfoFromBuffer(S.memberId);s._oSocialProfile.setSettings(S);s._oSocialProfile.open();},_onAddPost:function(c){if(!this._sBusinessObjectKey){this._oLogger.error("The business object key is undefined");this._oCommonUtil.displayError(this._oLanguageBundle.getText('ST_ADD_POST_NO_OBJECT_ERROR'));return;}var i={"appContext":this._oBusinessObjectMap.applicationContext,"collection":this._oBusinessObjectMap.collection,"key":this._sBusinessObjectKey,"odataServicePath":this._oBusinessObjectMap.servicePath};var s=this;var C=c.getParameter("value");var e=function(){s._oCommonUtil.displayError();s._oTimeline.setBusy(false);};if(C&&C.trim()!==""){var a=this._oTimelineDataHandler.addTopLevelPost(C,i);if(!this._oFilter.backend){this._oTimeline.setBusyIndicatorDelay(0).setBusy(true);a.then(function(A){return s._oJamDataHandler.getFeedEntryFromActivity(A.Id);},e).then(function(f){f.promise.done(function(d,r){var j=d.results;var I=s._oTimelineDataHandler.buildImageUrl(j.Creator.ThumbnailImage.Id,j.Creator.ThumbnailImage.ThumbnailImageType);var F={_feedEntryData:j,timelineItemData:{dateTime:j.CreatedAt,icon:"sap-icon://post",text:j.Text,title:j.Action,userEmail:j.Creator.Email,userName:j.Creator.FullName,userPicture:I}};var m=s._oTimeline.getModel().getData();m.timelineData.push(F);s._oTimeline.setBusy(false);var t=new sap.suite.ui.commons.TimelineItem({dateTime:new Date(j.CreatedAt),userName:j.Creator.FullName,title:j.Action,text:j.Text,icon:"sap-icon://post",userNameClickable:true,userNameClicked:s._onUserNameClicked,userPicture:I,replyCount:"{_feedEntryData/RepliesCount}",replyListOpen:s._onReplyListOpen.bind(s),replyList:new sap.m.List({showNoData:false,width:"20rem"}),replyPost:s._onReplyPost.bind(s),suggest:s._onSuggest.bind(s)});s._oTimeline.addContent(t);if(!s._oTimelineDataHandler.getUserInfoFromBuffer(j.Creator.Email)){s._oTimelineDataHandler.addUserInfoToBuffer(j.Creator);}var b=m.timelineData.indexOf(F);t.getParent().getModel().createBindingContext("/timelineData/"+b);var o=new sap.ui.model.Context(t.getParent().getModel(),"/timelineData/"+b);t.setBindingContext(o);});f.promise.fail(e);});}}},_onSuggest:function(e){if(!e.getSource().getBinding('suggestionItems')){var s=new sap.m.StandardListItem({title:"{name}",description:"{email}"});e.getSource().bindAggregation("suggestionItems",{path:"/suggestions",template:s});}if(this.gettingSuggestions){this.gettingSuggestions.request.abort();}var v=e.getParameter("suggestValue").substring(1);var t=this._oTimelineModel.getData();if(v.length==1){t.suggestions=[];this._oTimelineModel.setData(t);}var a=this;this.gettingSuggestions=this._oJamDataHandler.getSuggestions(v);this.gettingSuggestions.promise.done(function(d,r){var j=d.results;var S=[];t.suggestions=[];for(var i=0;i<j.length;i++){S.push({"name":j[i].FullName,"email":j[i].Email});}t.suggestions=t.suggestions.concat(S);a._oTimelineModel.setData(t);});this.gettingSuggestions.promise.fail(function(E){if(E.response&&E.response.statusCode){a._oCommonUtil.displayError();}});},_onCustomActionClicked:function(c){var C={};var b=c.getSource().getBindingContext();var B=b.getPath();var o=c.getSource().getModel().getProperty(B+"/timelineItemData/customActionData/oDataEntry");C.oDataEntry=o;C.timelineEntryId=c.getParameters().id;C.key=c.getParameters().key;this.fireCustomActionPress(C);},_onReplyListOpen:function(e){var s=this;var t=e.getSource();try{var f=this._getFeedId(t);if(!f){throw new Error('Failed to get the feed entry ID.');}}catch(E){this._oLogger.error('Failed to get the feed entry ID');this._oCommonUtil.displayError(this._oLanguageBundle.getText('ST_GET_REPLIES_FAILED'));return;}t.getReplyList().setBusyIndicatorDelay(0).setBusy(true);var g=this._oJamDataHandler.getReplies(f);g.promise.done(function(j,r){var J=j.results;J.reverse();t.getReplyList().removeAllItems();for(var i=0;i<J.length;i++){var R=J[i];t.getReplyList().addItem(new sap.m.FeedListItem({text:R.Text,icon:s._oTimelineDataHandler.buildImageUrl(R.ThumbnailImage.Id,R.ThumbnailImage.ThumbnailImageType),timestamp:s._oCommonUtil.formatDateToString(R.CreatedAt),sender:R.Creator.FullName,iconActive:false,senderActive:false}));}t.getReplyList().setBusy(false);});g.promise.fail(function(){s._oLogger.error('Failed to get the replies.');s._oCommonUtil.displayError(s._oCommonUtil.getLanguageBundle().getText('ST_GET_REPLIES_FAILED'));});},_onReplyPost:function(e){var s=this;var r=e.getParameter("value");if(r&&r.trim()!==""){var t=e.getSource();try{var f=this._getFeedId(t);if(!f){throw new Error('Failed to get the feed entry ID.');}}catch(E){this._oLogger.error('Failed to get the feed entry ID');this._oCommonUtil.displayError(this._oLanguageBundle.getText('ST_POST_REPLY_FAILED'));return;}var p=this._oJamDataHandler.postReply(f,r);p.promise.done(function(j,a){t.getReplyList().addItem(new sap.m.FeedListItem({text:r,icon:"{timelineItemData/userPicture}",timestamp:s._oCommonUtil.formatDateToString(new Date()),sender:s._oTimelineUser.FullName,iconActive:false,senderActive:false}));t.setReplyCount(t.getReplyList().getItems().length);});p.promise.fail(function(){s._oLogger.error('Failed to post the reply.');s._oCommonUtil.displayError(s._oCommonUtil.getLanguageBundle().getText('ST_POST_REPLY_FAILED'));});}},_appendListObserver:function(l){var s=this;var M=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;var r=l.getParent();var R=r.getDomRef();var t=l.getParent().getContent()[1];s.oListObserver=new M(function(m){var i=false;m.forEach(function(a){if(!i&&a.type==='attributes'){t.getParent().focus();t.focus();s.oListObserver.takeRecords();s.oListObserver.disconnect();i=true;}});});s.oListObserver.observe(R,{childList:false,attributes:true,subTree:false});},_validateInputParameters:function(){var c=this.getCustomFilter();if(c){if(!jQuery.isArray(c)){this._oLogger.error("The type defined for the property customFilter is not an array and not be included in the filter.");this.setCustomFilter([]);}else{for(var i=0;i<c.length;i++){if(!c[i].value||!c[i].text||typeof(c[i].value)!=="string"||typeof(c[i].text)!=="string"){this._oLogger.error("The value or text for the filter "+JSON.stringify(c[i])+" is not defined or not a string. It has been removed from the filter list.");c.splice(i,1);i--;}}}}else{this.setCustomFilter([]);}}});
