/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler");jQuery.sap.require("sap.collaboration.components.utils.OdataUtil");sap.ui.base.Object.extend("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler",{constructor:function(c){this._oLogger=jQuery.sap.log.getLogger("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler");this._oOdataUtil=new sap.collaboration.components.utils.OdataUtil();this._oCollabModel=c;this._oExternalBObuffer={};},addPostToExternalObject:function(c,e){var s=this;var a=this.getExternalObject(e).then(function(E){return s.postFeedEntryToObject(c,E);}).then(function(p){return p.promise;}).then(function(d,r){return d.results;}).fail(function(E){return E;});return a;},getExternalObject:function(e){var s=this;var b=e.ObjectType+e.Exid;var p=new jQuery.Deferred();if(!this._oExternalBObuffer[b]){var g=this.getExternalObjectByExidAndObjectType(e.Exid,e.ObjectType);g.promise.done(function(d,r){var E=d.results;s._oExternalBObuffer[b]=E;p.resolve(E);});g.promise.fail(function(E){if(E.response.statusCode==404){var c=s.postExternalObject(e);c.promise.done(function(d,r){var o=d.results;s._oExternalBObuffer[b]=o;p.resolve(o);});c.promise.fail(function(E){p.reject(E);});}else{p.reject(E);}});}else{p.resolve(this._oExternalBObuffer[b]);}return p;},getExternalObjectByExidAndObjectType:function(e,o){var s=this;var E="/ExternalObjects_FindByExidAndObjectType";var p=new jQuery.Deferred();var g=function(d,r){s._oLogger.info("External object found: "+d.results.Name);p.resolve(d,r);};var a=function(b){s._oLogger.error(b.response.statusText);p.reject(b);};var P={context:null,urlParameters:{"Exid":"'"+e.replace(/'/g,"''")+"'","ObjectType":"'"+o.replace(/'/g,"''")+"'"},async:true,filters:[],sorters:[],success:g,error:a};return{request:this._oCollabModel.read(E,P),promise:p};},getFeedEntries:function(e,n){var s=this;var E="";if(n){E=n;}else{E="/ExternalObjects"+"('"+jQuery.sap.encodeURL(e.Id)+"')/FeedEntries";}var p=new jQuery.Deferred();var S=function(d,r){s._oLogger.info("Feed entries were successfully retrieved.");p.resolve(d,r);};var f=function(o){s._oLogger.error("Failed to retrieve feed entries: "+o.response.statusText);p.reject(o);};var P={context:null,urlParameters:{"$expand":"Creator/ThumbnailImage,Creator/MemberProfile"},async:true,success:S,error:f};return{request:this._oCollabModel.read(E,P),promise:p};},getSuggestions:function(v){var s=this;var e="/Members_Autocomplete";var p=new jQuery.Deferred();var S=function(d,r){p.resolve(d,r);};var E=function(o){p.reject(o);};var P={urlParameters:{"Query":"'"+v+"'"},async:true,success:S,error:E};return{request:this._oCollabModel.read(e,P),promise:p};},getFeedEntryFromActivity:function(a){var s=this;var e="/Activities('"+jQuery.sap.encodeURL(a)+"')/FeedEntry";var p=new jQuery.Deferred();var S=function(d,r){p.resolve(d,r);};var E=function(o){s._oLogger.error("Failed to get the feed entry: "+o.response.statusText);p.reject(o);};var P={urlParameters:{$expand:"Creator/ThumbnailImage"},async:true,success:S,error:E};return{request:this._oCollabModel.read(e,P),promise:p};},getReplies:function(f){var s=this;var e="/FeedEntries('"+jQuery.sap.encodeURL(f)+"')/Replies";var p=new jQuery.Deferred();var S=function(d,r){s._oLogger.info("Replies were successfully retrieved.");p.resolve(d,r);};var E=function(o){s._oLogger.error("Failed to retrieve replies: "+o.response.statusText,o.stack);p.reject(o);};var u={'$top':100,'$orderby':'CreatedAt desc','$expand':'Creator,ThumbnailImage'};var P={context:null,urlParameters:u,async:true,success:S,error:E};return{request:this._oCollabModel.read(e,P),promise:p};},getMemberByAutocomplete:function(u){var s=this;var e="/Members_Autocomplete";var U={"Query":"'"+u+"'","$expand":"ThumbnailImage,MemberProfile"};var p=new jQuery.Deferred();var S=function(d,r){p.resolve(d,r);};var E=function(o){s._oLogger.error("Failed to get member information: "+o.response.statusText);p.reject(o);};var P={urlParameters:U,async:true,success:S,error:E};return{request:this._oCollabModel.read(e,P),promise:p};},getUserInfoBatch:function(u){var s=this;var b=[];u.forEach(function(U){var E="/Members_Autocomplete?Query='"+jQuery.sap.encodeURL(U)+"'&$expand=ThumbnailImage,MemberProfile";var m="GET";var d=null;var P=null;b.push(s._oCollabModel.createBatchOperation(E,m,d,P));});this._oCollabModel.addBatchReadOperations(b);var a=true;var p=new jQuery.Deferred();var S=function(d,r){var R=s._oOdataUtil.parseBatchResponse(d.__batchResponses);p.resolve(R,r);};var e=function(E){s._oLogger.error("Failed to get member information: "+E.response.statusText);p.reject(E);};return{request:this._oCollabModel.submitBatch(S,e,a),promise:p};},getSender:function(){var s=this;var e="/Self";var p=new jQuery.Deferred();var S=function(d,r){s._oLogger.info("The reply was successfully posted.");p.resolve(d.results);};var E=function(o){s._oLogger.error("Failed to retrieve the sender: "+o.response.statusText,o.stack);p.reject(o);};var P={urlParameters:null,async:true,success:S,error:E};return{request:this._oCollabModel.read(e,P),promise:p};},postExternalObject:function(e){var s=this;var E="/ExternalObjects";var d=e;var p=new jQuery.Deferred();var a=function(D,r){s._oLogger.info("External object created. "+D.results.Name);p.resolve(D,r);};var b=function(o){s._oLogger.error("Failed to create external object: "+o.response.statusText);p.reject(o);};var P={context:null,urlParameters:null,async:true,success:a,error:b};return{request:this._oCollabModel.create(E,d,P),promise:p};},postFeedEntryToObject:function(c,e){var s=this;var E="/Activities";var d={"Content":c,"Object":e,"Verb":"comment"};var p=new jQuery.Deferred();var S=function(D,r){p.resolve(D,r);};var f=function(o){s._oLogger.error("Failed to get the activity: "+o.response.statusText);p.reject(o);};var P={context:null,urlParameters:null,async:true,success:S,error:f};return{request:this._oCollabModel.create(E,d,P),promise:p};},postReply:function(f,r){var s=this;var e="/FeedEntries('"+jQuery.sap.encodeURL(f)+"')/Replies";var d={"Text":r};var p=new jQuery.Deferred();var S=function(D,a){s._oLogger.info("The reply was successfully posted.");p.resolve(D);};var E=function(o){s._oLogger.error("Failed to post reply: "+o.response.statusText,o.stack);p.reject(o);};var P={context:null,urlParameters:null,async:true,success:S,error:E};return{request:this._oCollabModel.create(e,d,P),promise:p};}});
