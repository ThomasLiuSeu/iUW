/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler");jQuery.sap.require("sap.collaboration.components.socialtimeline.datahandlers.ServiceDataHandler");jQuery.sap.require("sap.collaboration.components.socialtimeline.datahandlers.SMIntegrationDataHandler");jQuery.sap.require("sap.collaboration.components.socialtimeline.annotations.TimelineTermsUtility");sap.ui.base.Object.extend("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler",{constants:{FILTER_JAM_ALL:"filter_jam_all",FILTER_BACKEND_ALL:"filter_backend_all"},constructor:function(b,j,s,p,e){this._oLogger=jQuery.sap.log.getLogger("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler");this._oBusinessObjectMap=b;this._sBusinessObjectKey="";this._oBOModel=this._oBusinessObjectMap.serviceModel;this._oCollabModel=j._oCollabModel;this._oSMIntegrationModel=s;this._oJamDataHandler=j;this._iPageSize=p;this._iTimelineEntriesPageSize=p;this._iTimelineEntriesSkip=0;this._iFeedEntriesPageSize=p*2;this._sFeedEntriesNextLink="";this._fCustomActionCallBack=b.customActionCallback;this._bEnableSocial=e;this._oTimelineTermsUtility=new sap.collaboration.components.socialtimeline.annotations.TimelineTermsUtility(this._oBOModel.getServiceMetadata(),this._oBOModel.getServiceAnnotations());this._oServiceDataHandler=new sap.collaboration.components.socialtimeline.datahandlers.ServiceDataHandler(this._oBOModel,this._oTimelineTermsUtility);this._oSMIntegrationDataHandler=new sap.collaboration.components.socialtimeline.datahandlers.SMIntegrationDataHandler(this._oSMIntegrationModel);this._aTimelineEntries=[];this._aFeedEntries=[];this._oMemberDataBuffer={};},setBusinessObjectKey:function(k){this.reset();this._sBusinessObjectKey=k;if(this._oTimelineEntriesReadRequest){this._oTimelineEntriesReadRequest.abort();}if(this._oFeedEntriesReadRequest){this._oFeedEntriesReadRequest.abort();}},getTimelineData:function(f){var s=this;var p=jQuery.Deferred();var r=new jQuery.Deferred();var a=new jQuery.Deferred();if(this._bEnableSocial===true&&!f.backend){var g=this._getFeedEntries();g.done(function(F){var t=s._mapFeedEntriesToTimelineItems(F);a.resolve(t);});g.fail(function(e){p.reject(e);});}else{a.resolve([]);}if(!f.jam){var b=this._getTimelineEntries(f.backend);b.done(function(t){var T=s._mapTimelineEntriesToTimelineItems(t);if(s._bEnableSocial===true){var c=s._fillPicturesForTimelineItems(T);c.always(function(d){r.resolve(d);});}else{r.resolve(T);}s._iTimelineEntriesSkip+=s._iTimelineEntriesPageSize;});b.fail(function(e){p.reject(e);});}else{r.resolve([]);}jQuery.when(r,a).then(function(t,F){var T=s._mergeEntries(t,F);p.resolve(T);},function(e){p.reject(e);});return p;},addTopLevelPost:function(c,i){var s=this;return this._oSMIntegrationDataHandler.mapInternalBOToExternalBO(i).then(function(e){return s._oJamDataHandler.addPostToExternalObject(c,e);});},reset:function(){this._iTimelineEntriesSkip=0;this._sFeedEntriesNextLink="";this._aTimelineEntries=[];this._aFeedEntries=[];},_getFeedEntries:function(){var s=this;var i={"appContext":this._oBusinessObjectMap.applicationContext,"collection":this._oBusinessObjectMap.collection,"key":this._sBusinessObjectKey,"odataServicePath":this._oBusinessObjectMap.servicePath};var p=this._oSMIntegrationDataHandler.mapInternalBOToExternalBO(i).then(function(e){return s._oJamDataHandler.getExternalObject(e);}).then(function(e){if(s._sFeedEntriesNextLink==undefined){var g=new jQuery.Deferred();g.resolve({"results":[]},null);return{request:null,promise:g};}else if(s._sFeedEntriesNextLink==""){return s._oJamDataHandler.getFeedEntries(e);}else{return s._oJamDataHandler.getFeedEntries(e,s._sFeedEntriesNextLink);}}).then(function(g){s._oFeedEntriesReadRequest=g.request;return g.promise;}).then(function(f){s._sFeedEntriesNextLink=f.__next;return f.results;});return p;},_mapFeedEntriesToTimelineItems:function(f){var s=this;var t=[];f.forEach(function(F){var T={};T.timelineItemData=s._mapFeedEntryToTimelineItem(F);T._feedEntryData=F;t.push(T);});return t;},_mapFeedEntryToTimelineItem:function(f){var P="sap-icon://post";if(!this.getUserInfoFromBuffer(f.Creator.Email)){this.addUserInfoToBuffer(f.Creator);}var t={dateTime:f.CreatedAt,userName:f.Creator.FullName,userEmail:f.Creator.Email,title:f.Action,text:f.Text,icon:P};t.userPicture=this.getUserPicture(t.userEmail);return t;},_mapTimelineEntriesToTimelineItems:function(t){var s=this;var T=[];t.forEach(function(o){var a={};a.timelineItemData=s._mapTimelineEntryToTimelineItem(o);var c=undefined;if(s._fCustomActionCallBack){c=s._fCustomActionCallBack(o);if(c&&!jQuery.isArray(c)){s._oLogger.error("The property customActionCallback does not return an array.");}else if(c){c.oDataEntry=o;a.timelineItemData.customActionData=c;}}T.push(a);});return T;},_mapTimelineEntryToTimelineItem:function(t){var T=this._oTimelineTermsUtility.getTimelineEntryFields(this._oBusinessObjectMap.collection);var o={dateTime:t[T.TimeStamp],userName:t[T.ActorName],userEmail:t[T.ActorExtID].toLowerCase(),title:t[T.ActionText],text:t[T.SummaryText],icon:t[T.Icon],timelineEntryDetails:this._processTimelineEntryDetails(t[T.TimelineDetailNavigationPath].results,this._oBusinessObjectMap.collection)};o.userPicture=this.getUserPicture(o.userEmail);return o;},_processTimelineEntryDetails:function(t,e){var s=this;var T=[];var o=s._oTimelineTermsUtility.getTimelineEntryDetailFields(e);t.forEach(function(a){var d={};d.afterValue=a[o.AfterValue];d.beforeValue=a[o.BeforeValue];d.changeType=a[o.ChangeType];d.propertyLabel=a[o.PropertyLabel];T.push(d);});return T;},_mergeEntries:function(t,f){this._aTimelineEntries=this._aTimelineEntries.concat(t);this._aFeedEntries=this._aFeedEntries.concat(f);var T=[];var o=this._aTimelineEntries.shift();var F=this._aFeedEntries.shift();do{if(!o&&!F){break;}else if(!o&&F){T.push(F);F=this._aFeedEntries.shift();}else if(o&&!F){T.push(o);o=this._aTimelineEntries.shift();}else{if(o.timelineItemData.dateTime==F.timelineItemData.dateTime){T.push(F);F=this._aFeedEntries.shift();}else if(o.timelineItemData.dateTime>F.timelineItemData.dateTime){T.push(o);o=this._aTimelineEntries.shift();}else if(o.timelineItemData.dateTime<F.timelineItemData.dateTime){T.push(F);F=this._aFeedEntries.shift();}}}while(T.length<this._iPageSize);if(o){this._aTimelineEntries.unshift(o);}if(F){this._aFeedEntries.unshift(F);}return T;},_fillPicturesForTimelineItems:function(t){var s=this;var p=jQuery.Deferred();var e=[];t.forEach(function(T){if(!T.timelineItemData.userPicture){e.push(T.timelineItemData.userEmail);}});var u=e.filter(function(a,i){return e.indexOf(a)==i;});if(u.length>0){var g=this._oJamDataHandler.getUserInfoBatch(u);g.promise.done(function(U){U=jQuery.grep(U,function(o){return o.results.length>0});U.forEach(function(o){s.addUserInfoToBuffer(o.results[0]);});t.forEach(function(T){if(!T.timelineItemData.userPicture){T.timelineItemData.userPicture=s.getUserPicture(T.timelineItemData.userEmail);}});p.resolve(t);});g.promise.fail(function(E){p.resolve(t);});}else{p.resolve(t);}return p;},_getTimelineEntries:function(f){if(f===this.constants.FILTER_BACKEND_ALL){f=undefined;}var r=this._oServiceDataHandler.readTimelineEntries(this._oBusinessObjectMap.collection,this._sBusinessObjectKey,f,this._iTimelineEntriesSkip,this._iTimelineEntriesPageSize);this._oTimelineEntriesReadRequest=r.request;return r.promise;},getUserPicture:function(u){var m=this.getUserInfoFromBuffer(u);if(!m){return"";}return m.picture;},buildImageUrl:function(i,I){return this._oCollabModel.sServiceUrl+"/ThumbnailImages"+"(Id='"+jQuery.sap.encodeURL(i)+"',ThumbnailImageType='"+jQuery.sap.encodeURL(I)+"')/$value";},addUserInfoToBuffer:function(m){var u=this.buildImageUrl(m.ThumbnailImage.Id,m.ThumbnailImage.ThumbnailImageType);var U=m.Email.toLowerCase();this._oMemberDataBuffer[U]={"email":U,"fullname":m.FullName,"id":m.Id,"address":m.MemberProfile.Address,"title":m.Title,"role":m.Role,"picture":u};},getUserInfoFromBuffer:function(u){var U=u.toLowerCase();return this._oMemberDataBuffer[U];},getJamConfigurationStatus:function(c,C){var s=function(b){c(b);};var e=function(E){C(E);};this._oSMIntegrationDataHandler.getJamConfigurationStatus(this._oSMIntegrationModel,s,e);}});
