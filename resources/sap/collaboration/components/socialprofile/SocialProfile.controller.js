/*!
 * @copyright@
 */
jQuery.sap.require("sap.collaboration.components.utils.CommonUtil");jQuery.sap.require("sap.collaboration.components.utils.OdataUtil");sap.ui.controller("sap.collaboration.components.socialprofile.SocialProfile",{onInit:function(){this._sJamODataServiceUrl=this.getView().getViewData().collaborationHostServiceUrl;this._oODataUtil=new sap.collaboration.components.utils.OdataUtil();this._oCommonUtil=new sap.collaboration.components.utils.CommonUtil();this._sPrefixId=this.getView().getId();this._sJamURL="";this._sJamUserId="";this._sPopoverPrefix=this.getView().getViewData().popoverPrefix;},onBeforeRendering:function(){if(!this._oJamODataModel){this._initializeJamODataModel();}if(!this._oSMIODataModel){this._initializeSMIODataModel();}if(!this._oJSONModel){this._initializeJSONModel();}if(!this._sJamURL){this._fetchJamURL();this._attachJamButtonPress();}if(this._memberId!==this.getView().getViewData().memberId){this.getView().resetHeader();this._clearViewData();this._memberId=this.getView().getViewData().memberId;var m=this.getView().getViewData().memberInfo;if(!m){this._fetchData();}else{this._fillData(m);}}},_initializeJamODataModel:function(){var a=true;this._sJamODataServiceUrl=this.getView().getViewData().collaborationHostServiceUrl;this._oJamODataModel=new sap.ui.model.odata.ODataModel(this._sJamODataServiceUrl,a);},_initializeSMIODataModel:function(){var a=true;this._sSMIODataServiceUrl=this.getView().getViewData().smiServiceUrl;this._oSMIODataModel=new sap.ui.model.odata.ODataModel(this._sSMIODataServiceUrl,a);},_initializeJSONModel:function(){this._oJSONModel=new sap.ui.model.json.JSONModel({});this.getView().setModel(this._oJSONModel);},_attachJamButtonPress:function(){var s=this;var j=sap.ui.getCore().byId(this._sPopoverPrefix+"_JamButton");j.attachPress(function(){window.open(s._sJamURL+"/profile/wall/"+s._sJamUserId,"_blank");});},_fetchJamURL:function(){var a=true;var s=this;var f=new jQuery.Deferred();f.done(function(j){s._sJamURL=j;});f.fail(function(e){jQuery.sap.log.error("SAP Jam request failed at sap.collaboration.components.socialprofile.SocialProfileController._fetchJamURL()");s._oCommonUtil.displayError();});this._oODataUtil.getJamUrl(this._oSMIODataModel,f,a);},_fetchData:function(){var s=this;if(this._oSocialProfileRequest){this._oSocialProfileRequest.abort();}this._oSocialProfileRequest=this._oJamODataModel.read("Members_Autocomplete",{success:function(d,r){var j=d.results[0];var R=sap.ui.getCore().byId(s._sPopoverPrefix+"_Popover");s._oJSONModel.setData(j);if(d.results[0]){var i=s._sJamODataServiceUrl+"/ThumbnailImages"+"(Id='"+jQuery.sap.encodeURL(j.ThumbnailImage.Id)+"',ThumbnailImageType='"+jQuery.sap.encodeURL(j.ThumbnailImage.ThumbnailImageType)+"')/$value";sap.ui.getCore().byId(s._sPrefixId+"_HeaderUserImage").setSrc(i);s._sJamUserId=j.Id;R.getBeginButton().setEnabled(true);s._fetchMemberPhoneNumbers(s._sJamUserId,s._oJSONModel);}else{s.getView().setHeaderNoUser();}},error:function(e){if(e.response&&e.response.statusCode){jQuery.sap.log.error("SAP Jam request failed at sap.collaboration.components.socialprofile.SocialProfileController._fetchData()");s._oCommonUtil.displayError();}},urlParameters:{"Query":"'"+this._memberId+"'","$expand":"ThumbnailImage,MemberProfile"}});},_fetchMemberPhoneNumbers:function(j,_){var s=this;this._oJamODataModel.read("MemberProfiles('"+j+"')"+"/PhoneNumbers",{success:function(d,r){var J=d.results;var w="";var m="";for(var i=0,R=J.length;i<R;i++){if(J[i]['PhoneNumberType']==='Work'){w=J[i]['PhoneNumber'];}if(J[i]['PhoneNumberType']==='Mobile'){m=J[i]['PhoneNumber'];}}_.setProperty("/MemberProfile/PhoneNumbers",{Work:w,Mobile:m});},error:function(e){jQuery.sap.log.error("SAP Jam request failed at sap.collaboration.components.socialprofile.SocialProfileController._fetchMemberPhoneNumbers()");s._oCommonUtil.displayError();}});},_fillData:function(m){var M={"Id":m.id,"FullName":m.fullname,"Title":m.title,"Email":m.email,"MemberProfile":{"Address":m.address,"PhoneNumbers":{}}};this._oJSONModel.setData(M);sap.ui.getCore().byId(this._sPrefixId+"_HeaderUserImage").setSrc(m.picture);this._sJamUserId=m.id;var r=sap.ui.getCore().byId(this._sPopoverPrefix+"_Popover");r.getBeginButton().setEnabled(true);this._fetchMemberPhoneNumbers(this._sJamUserId,this._oJSONModel);},_clearViewData:function(){sap.ui.getCore().byId(this._sPrefixId+"_HeaderUserImage").setSrc();sap.ui.getCore().byId(this._sPrefixId+"_FullName").setText();sap.ui.getCore().byId(this._sPrefixId+"_Role").setText();sap.ui.getCore().byId(this._sPrefixId+"_MobileNumber").setText();sap.ui.getCore().byId(this._sPrefixId+"_WorkNumber").setText();sap.ui.getCore().byId(this._sPrefixId+"_Email").setText();sap.ui.getCore().byId(this._sPrefixId+"_CompanyAddress").setText();sap.ui.getCore().byId(this._sPopoverPrefix+"_Popover").getBeginButton().setEnabled(false);}});
